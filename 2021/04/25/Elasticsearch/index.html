<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Gemini&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}</script>
<meta name="description" content="下载地址ElasticSearch:https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;elasticsearch&#x2F;?C&#x3D;N&amp;O&#x3D;D logstash:https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;logstash&#x2F;?C&#x3D;N&amp;O&#x3D;D kibana:https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;kibana&#x2F;?C&#x3D;N&amp;O&#x3D;D">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch">
<meta property="og:url" content="http://example.com/2021/04/25/Elasticsearch/index.html">
<meta property="og:site_name" content="vivid的博客">
<meta property="og:description" content="下载地址ElasticSearch:https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;elasticsearch&#x2F;?C&#x3D;N&amp;O&#x3D;D logstash:https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;logstash&#x2F;?C&#x3D;N&amp;O&#x3D;D kibana:https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;kibana&#x2F;?C&#x3D;N&amp;O&#x3D;D">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MyhangsYourdream/cloud-img//img/20210425220803.png">
<meta property="og:image" content="https://uploader.shimo.im/f/FVhBg8v7p687kzve.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="og:image" content="https://uploader.shimo.im/f/FwDlpWAbcjHhpGz5.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="og:image" content="https://uploader.shimo.im/f/vZAkpLGIO05RRuhA.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="og:image" content="https://uploader.shimo.im/f/QVI5lK9zxPKY6aQU.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="og:image" content="https://uploader.shimo.im/f/IjpxQLd6oGrMPx02.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="og:image" content="https://uploader.shimo.im/f/caJcoGuGtgm1DPYc.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="og:image" content="https://uploader.shimo.im/f/15mx3yrtT7fbkssf.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="og:image" content="https://uploader.shimo.im/f/NvahJNUHKcMyansE.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg">
<meta property="article:published_time" content="2021-04-25T14:04:31.000Z">
<meta property="article:modified_time" content="2021-04-25T14:09:24.729Z">
<meta property="article:author" content="vivid">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/MyhangsYourdream/cloud-img//img/20210425220803.png">


<link rel="canonical" href="http://example.com/2021/04/25/Elasticsearch/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2021&#x2F;04&#x2F;25&#x2F;Elasticsearch&#x2F;&quot;,&quot;path&quot;:&quot;2021&#x2F;04&#x2F;25&#x2F;Elasticsearch&#x2F;&quot;,&quot;title&quot;:&quot;Elasticsearch&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Elasticsearch | vivid的博客</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">vivid的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80"><span class="nav-number">1.</span> <span class="nav-text">下载地址</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number"></span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#windos%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">windos安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">docker安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B"><span class="nav-number">3.</span> <span class="nav-text">集群状态查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IK-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">4.</span> <span class="nav-text">IK 分词器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">4.1.</span> <span class="nav-text">测试分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-IK-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">4.2.</span> <span class="nav-text">安装 IK 分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E5%88%86%E8%AF%8D%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.3.</span> <span class="nav-text">两种分词模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number"></span> <span class="nav-text">ES 快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">1.</span> <span class="nav-text">1 创建索引库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%98%A0%E5%B0%84"><span class="nav-number">2.</span> <span class="nav-text">2 映射</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E6%A6%82%E5%BF%B5%E8%AF%B4%E6%98%8E"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 概念说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 创建映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%B9%B6%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.3.</span> <span class="nav-text">创建索引并指定数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link"><span class="nav-number">2.4.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.5.</span> <span class="nav-text">2.3 数据类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3"><span class="nav-number">2.6.</span> <span class="nav-text">2.4 创建文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-%E7%AE%80%E5%8D%95%E6%90%9C%E7%B4%A2"><span class="nav-number">2.7.</span> <span class="nav-text">2.5 简单搜索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6%E6%9B%B4%E6%96%B0%E6%98%A0%E5%B0%84"><span class="nav-number">2.8.</span> <span class="nav-text">2.6更新映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-%E5%88%A0%E9%99%A4%E6%98%A0%E5%B0%84"><span class="nav-number">2.9.</span> <span class="nav-text">2.7 删除映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-%E5%B8%B8%E7%94%A8%E6%98%A0%E5%B0%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.10.</span> <span class="nav-text">2.8 常用映射类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.</span> <span class="nav-text">3.数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-keyword-%E5%85%B3%E9%94%AE%E5%AD%97%E5%AD%97%E6%AE%B5"><span class="nav-number">3.1.</span> <span class="nav-text">1 keyword 关键字字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-date-%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.2.</span> <span class="nav-text">2 date 日期类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.3.</span> <span class="nav-text">3 数值类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E7%BB%BC%E5%90%88"><span class="nav-number">3.4.</span> <span class="nav-text">4 综合</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ES%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">4.</span> <span class="nav-text">4.ES客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">4.1.</span> <span class="nav-text">创建索引库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3"><span class="nav-number">4.2.</span> <span class="nav-text">添加文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="nav-number">4.3.</span> <span class="nav-text">更新文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-number">4.4.</span> <span class="nav-text">删除文档</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2%E7%AE%A1%E7%90%86"><span class="nav-number"></span> <span class="nav-text">搜索管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="nav-number">1.</span> <span class="nav-text">创建映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A3"><span class="nav-number">2.</span> <span class="nav-text">查询所有文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.</span> <span class="nav-text">分页查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Term-Query-and-terms"><span class="nav-number">4.</span> <span class="nav-text">Term Query and terms</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AEid%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D"><span class="nav-number">5.</span> <span class="nav-text">根据id精确匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#match-Query"><span class="nav-number">6.</span> <span class="nav-text">match Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#multi-Query"><span class="nav-number">7.</span> <span class="nav-text">multi Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="nav-number">8.</span> <span class="nav-text">布尔查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E8%99%91%E5%99%A8"><span class="nav-number">9.</span> <span class="nav-text">过虑器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">10.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="nav-number">11.</span> <span class="nav-text">高亮显示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prefix-%E6%9F%A5%E8%AF%A2"><span class="nav-number">12.</span> <span class="nav-text">prefix 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fuzzy-%E6%9F%A5%E8%AF%A2"><span class="nav-number">13.</span> <span class="nav-text">fuzzy 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wildcard-%E6%9F%A5%E8%AF%A2"><span class="nav-number">14.</span> <span class="nav-text">wildcard 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2%E6%8E%A8%E8%8D%90-match-phrase-prefix"><span class="nav-number">15.</span> <span class="nav-text">搜索推荐 match_phrase_prefix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rang-%E6%9F%A5%E8%AF%A2"><span class="nav-number">16.</span> <span class="nav-text">rang 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#regexp-%E6%9F%A5%E8%AF%A2"><span class="nav-number">17.</span> <span class="nav-text">regexp 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5-scrol-l"><span class="nav-number">18.</span> <span class="nav-text">深分页 scrol l</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delete-by-query"><span class="nav-number">19.</span> <span class="nav-text">delete-by-query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#boosting-%E6%9F%A5%E8%AF%A2"><span class="nav-number">20.</span> <span class="nav-text">boosting 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">21.</span> <span class="nav-text">聚合查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%BE%E7%BB%8F%E7%BA%AC%E5%BA%A6%E6%90%9C%E7%B4%A2"><span class="nav-number">22.</span> <span class="nav-text">图经纬度搜索</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7%E4%B8%AA%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-number"></span> <span class="nav-text">7个查询优化技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A71"><span class="nav-number">1.</span> <span class="nav-text">优化技巧1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A72"><span class="nav-number">2.</span> <span class="nav-text">优化技巧2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A73"><span class="nav-number">3.</span> <span class="nav-text">优化技巧3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A74"><span class="nav-number">4.</span> <span class="nav-text">优化技巧4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A76"><span class="nav-number">5.</span> <span class="nav-text">优化技巧6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A77"><span class="nav-number">6.</span> <span class="nav-text">优化技巧7</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">vivid</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/25/Elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vivid">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="vivid的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Elasticsearch
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-04-25 22:04:31 / 修改时间：22:09:24" itemprop="dateCreated datePublished" datetime="2021-04-25T22:04:31+08:00">2021-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%9B%B8%E5%85%B3/" itemprop="url" rel="index"><span itemprop="name">大数据相关</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h3><p>ElasticSearch:<a target="_blank" rel="noopener" href="https://mirrors.huaweicloud.com/elasticsearch/?C=N&O=D">https://mirrors.huaweicloud.com/elasticsearch/?C=N&amp;O=D</a></p>
<p>logstash:<a target="_blank" rel="noopener" href="https://mirrors.huaweicloud.com/logstash/?C=N&O=D">https://mirrors.huaweicloud.com/logstash/?C=N&amp;O=D</a></p>
<p>kibana:<a target="_blank" rel="noopener" href="https://mirrors.huaweicloud.com/kibana/?C=N&O=D">https://mirrors.huaweicloud.com/kibana/?C=N&amp;O=D</a></p>
<span id="more"></span>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="windos安装"><a href="#windos安装" class="headerlink" title="windos安装"></a>windos安装</h3><p>下载Elasticsearch<code>7.6.2</code>的zip包，并解压到指定目录</p>
<ul>
<li><p>安装中文分词插件，在<code>elasticsearch-7.6.2\bin</code>目录下执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-plugin install https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik&#x2F;releases&#x2F;download&#x2F;v7.6.2&#x2F;elasticsearch-analysis-ik-7.6.2.zip</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/MyhangsYourdream/cloud-img//img/20210425220803.png" alt="图片"></p>
</li>
<li><p>运行bin目录下的<code>elasticsearch.bat</code>启动Elasticsearch服务。</p>
<h3 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h3></li>
<li><p>下载Elasticsearch<code>7.6.2</code>的docker镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:7.6.2</span><br></pre></td></tr></table></figure></li>
<li><p>修改虚拟内存区域大小，否则会因为过小而无法启动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count&#x3D;262144</span><br></pre></td></tr></table></figure></li>
<li><p>使用如下命令启动Elasticsearch服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9200:9200 -p 9300:9300 --name elasticsearch \</span><br><span class="line">-e &quot;discovery.type&#x3D;single-node&quot; \</span><br><span class="line">-e &quot;cluster.name&#x3D;elasticsearch&quot; \</span><br><span class="line">-v &#x2F;mydata&#x2F;elasticsearch&#x2F;plugins:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins \</span><br><span class="line">-v &#x2F;mydata&#x2F;elasticsearch&#x2F;data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data \</span><br><span class="line">-d elasticsearch:7.6.2</span><br></pre></td></tr></table></figure></li>
<li><p>启动时会发现<code>/usr/share/elasticsearch/data</code>目录没有访问权限，只需要修改<code>/mydata/elasticsearch/data</code>目录的权限，再重新启动即可；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 &#x2F;mydata&#x2F;elasticsearch&#x2F;data&#x2F;</span><br></pre></td></tr></table></figure></li>
<li><p>安装中文分词器IKAnalyzer，并重新启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it elasticsearch &#x2F;bin&#x2F;bash</span><br><span class="line">#此命令需要在容器中运行</span><br><span class="line">elasticsearch-plugin install https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik&#x2F;releases&#x2F;download&#x2F;v7.6.2&#x2F;elasticsearch-analysis-ik-7.6.2.zip</span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure>
<h3 id="集群状态查看"><a href="#集群状态查看" class="headerlink" title="集群状态查看"></a><a target="_blank" rel="noopener" href="https://macrozheng.github.io/mall-learning/#/reference/elasticsearch_start?id=%e9%9b%86%e7%be%a4%e7%8a%b6%e6%80%81%e6%9f%a5%e7%9c%8b">集群状态查看</a></h3></li>
<li><p>查看集群健康状态；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_cat&#x2F;health?v</span><br></pre></td></tr></table></figure></li>
<li><p>查看节点状态；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_cat&#x2F;nodes?v</span><br></pre></td></tr></table></figure></li>
<li><p>查看所有索引信息；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_cat&#x2F;indices?v</span><br></pre></td></tr></table></figure>
<h3 id="IK-分词器"><a href="#IK-分词器" class="headerlink" title="IK 分词器"></a>IK 分词器</h3></li>
</ul>
<h4 id="测试分词器"><a href="#测试分词器" class="headerlink" title="测试分词器"></a>测试分词器</h4><p>在添加文档时会进行分词，索引中存放的就是一个一个的词（term），当你去搜索时就是拿关键字去匹配词，最终</p>
<p>找到词关联的文档。</p>
<p>测试当前索引库使用的分词器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post 发送：localhost:9200&#x2F;_analyze</span><br><span class="line">&#123;&quot;text&quot;:&quot;测试分词器，后边是测试内容：spring cloud 实战&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>结果会发现分词的效果将 “测试” 这个词拆分成两个单字“测”和“试”，这是因为当前索引库使用的分词器对中文就是单字分词。</p>
<h4 id="安装-IK-分词器"><a href="#安装-IK-分词器" class="headerlink" title="安装 IK 分词器"></a>安装 IK 分词器</h4><ul>
<li>使用 IK 分词器可以实现对中文分词的效果。</li>
<li>下载 IK 分词器：（Github 地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a>）</li>
<li>下载 zip：</li>
<li>解压，并将解压的文件拷贝到 ES 安装目录的 plugins 下的 ik 目录下</li>
<li>测试分词效果：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   post localhost:9200&#x2F;_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;text&quot;: &quot;测试分词器，后边是测试内容：spring cloud 实战&quot;,</span><br><span class="line">    &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="两种分词模式"><a href="#两种分词模式" class="headerlink" title="两种分词模式"></a>两种分词模式</h4></li>
</ul>
<p>ik 分词器有两种分词模式：ik_max_word 和 ik_smart 模式。</p>
<p>1、ik_max_word</p>
<p>会将文本做最细粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国、中华人民、中华、</p>
<p>华人、人民共和国、人民、共和国、大会堂、大会、会堂等词语。</p>
<p>2、ik_smart</p>
<p>会做最粗粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为中华人民共和国、人民大会堂。</p>
<p>测试两种分词模式：</p>
<p>发送：post localhost:9200/_analyze</p>
<p>{“text”:”中华人民共和国人民大会堂”,”analyzer”:”ik_smart” }</p>
<p>4.4 自定义词库</p>
<p>如果要让分词器支持一些专有词语，可以自定义词库。</p>
<p>iK 分词器自带一个 main.dic 的文件，此文件为词库文件。</p>
<p>在上边的目录中新建一个 my.dic 文件（注意文件格式为 utf-8（不要选择 utf-8 BOM））</p>
<p>可以在其中自定义词汇：</p>
<p>比如定义：</p>
<p>配置文件中配置 my.dic，</p>
<p>重启 ES，测试分词效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">发送：post localhost:9200&#x2F;_analyze</span><br><span class="line">&#123;&quot;text&quot;:&quot;测试分词器，后边是测试内容：spring cloud 实战&quot;,&quot;analyzer&quot;:&quot;ik_max_word&quot; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="ES-快速入门"><a href="#ES-快速入门" class="headerlink" title="ES 快速入门"></a>ES 快速入门</h2><p>ES 作为一个索引及搜索服务，对外提供丰富的 REST 接口，快速入门部分的实例使用 head 插件来测试，目的是对 ES的使用方法及流程有个初步的认识。</p>
<h3 id="1-创建索引库"><a href="#1-创建索引库" class="headerlink" title="1 创建索引库"></a>1 创建索引库</h3><p>ES 的索引库是一个逻辑概念，它包括了分词列表及文档列表，同一个索引库中存储了相同类型的文档。它就相当于MySQL 中的表，或相当于 Mongodb 中的集合。</p>
<p>关于索引这个语：索引（名词）：ES 是基于 Lucene 构建的一个搜索服务，它要从索引库搜索符合条件索引数据。索引（动词）：索引库刚创建起来是空的，将数据添加到索引库的过程称为索引。下边介绍两种创建索引库的方法，它们的工作原理是相同的，都是客户端向 ES 服务发送命令。</p>
<ol>
<li><p>使用 postman 或 curl 这样的工具创建：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">put http://localhost:9200/索引库名称</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>number_of_shards：设置分片的数量，在集群中通常设置多个分片，表示一个索引库将拆分成多片分别存储不同的结点，提高了 ES 的处理能力和高可用性，入门程序使用单机环境，这里设置为 1。<br>number_of_replicas：设置副本的数量，设置副本是为了提高 ES 的高可靠性，单机环境设置0.</p>
</li>
<li><p>使用head插件创建</p>
</li>
</ol>
<p><img src="https://uploader.shimo.im/f/FVhBg8v7p687kzve.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
<h3 id="2-映射"><a href="#2-映射" class="headerlink" title="2 映射"></a>2 映射</h3><h4 id="2-1-概念说明"><a href="#2-1-概念说明" class="headerlink" title="2.1 概念说明"></a>2.1 概念说明</h4><p>在索引中每个文档都包括了一个或多个 field，创建映射就是向索引库中创建 field 的过程，下边是 document 和 field</p>
<p>与关系数据库的概念的类比：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Near Realtime（近实时）：Elasticsearch是一个近乎实时的搜索平台，这意味着从索引文档到可搜索文档之间只有一个轻微的延迟(通常是一秒钟)。</span><br><span class="line">Cluster（集群）：群集是一个或多个节点的集合，它们一起保存整个数据，并提供跨所有节点的联合索引和搜索功能。每个群集都有自己的唯一群集名称，节点通过名称加入群集。</span><br><span class="line">Node（节点）：节点是指属于集群的单个Elasticsearch实例，存储数据并参与集群的索引和搜索功能。可以将节点配置为按集群名称加入特定集群，默认情况下，每个节点都设置为加入一个名为elasticsearch的群集。</span><br><span class="line">Index（索引）：索引是一些具有相似特征的文档集合，类似于MySql中数据库的概念。</span><br><span class="line">Type（类型）：类型是索引的逻辑类别分区，通常，为具有一组公共字段的文档类型，类似MySql中表的概念。注意：在Elasticsearch 6.0.0及更高的版本中，一个索引只能包含一个类型。</span><br><span class="line">Document（文档）：文档是可被索引的基本信息单位，以JSON形式表示，类似于MySql中行记录的概念。</span><br><span class="line">Shards（分片）：当索引存储大量数据时，可能会超出单个节点的硬件限制，为了解决这个问题，Elasticsearch提供了将索引细分为分片的概念。分片机制赋予了索引水平扩容的能力、并允许跨分片分发和并行化操作，从而提高性能和吞吐量。</span><br><span class="line">Replicas（副本）：在可能出现故障的网络环境中，需要有一个故障切换机制，Elasticsearch提供了将索引的分片复制为一个或多个副本的功能，副本在某些节点失效的情况下提供高可用性。</span><br><span class="line">doc_values :支持排序</span><br></pre></td></tr></table></figure>
<p>注意：6.0 之前的版本有 type（类型）概念，type 相当于关系数据库的表，ES 官方将在 ES9.0 版本中彻底删除 type。</p>
<p>上边讲的创建索引库相当于关系数据库中的数据库还是表？</p>
<p>1、如果相当于数据库就表示一个索引库可以创建很多不同类型的文档，这在 ES 中也是允许的。</p>
<p>2、如果相当于表就表示一个索引库只能存储相同类型的文档，ES 官方建议 在一个索引库中只存储相同类型的文</p>
<p>档。</p>
<h4 id="2-2-创建映射"><a href="#2-2-创建映射" class="headerlink" title="2.2 创建映射"></a>2.2 创建映射</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post http:&#x2F;&#x2F;localhost:9200&#x2F;索引库名称&#x2F;类型名称&#x2F;_mapping</span><br></pre></td></tr></table></figure>
<p>创建类型为 xc_course 的映射，共包括三个字段：name、description、studymondel<br>由于 ES6.0 版本还没有将 type 彻底删除，所以暂时把 type 起一个没有特殊意义的名字。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post 请求： http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;_mapping</span><br></pre></td></tr></table></figure>
<p>表示：在 xc_course 索引库下的 doc 类型下创建映射。doc 是类型名，可以自定义，在 ES6.0 中要弱化类型的概念，<br>给它起一个没有具体业务意义的名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;description&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;studymodel&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建索引并指定数据结构"><a href="#创建索引并指定数据结构" class="headerlink" title="创建索引并指定数据结构"></a>创建索引并指定数据结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;book</span><br><span class="line">&#123;</span><br><span class="line">&quot;settings&quot;: &#123;</span><br><span class="line">#分片数</span><br><span class="line">&quot;number_of_shards&quot;: 5,</span><br><span class="line">#备份数</span><br><span class="line">&quot;number_of_replicas&quot;: 1</span><br><span class="line">&#125;,</span><br><span class="line">#指定数据类型</span><br><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">#类型 Type</span><br><span class="line">&quot;novel&quot;:&#123;</span><br><span class="line">#文档存储的field</span><br><span class="line">&quot;properties&quot;:&#123;</span><br><span class="line">#field属性名</span><br><span class="line">&quot;name&quot;:&#123;</span><br><span class="line">#类型</span><br><span class="line">&quot;type&quot;:&quot;text&quot;,</span><br><span class="line">#指定分词器</span><br><span class="line">&quot;analyzer&quot;:&quot;ik_max_word&quot;,</span><br><span class="line">#指定当前的field可以被作为查询的条件</span><br><span class="line">&quot;index&quot;:true,</span><br><span class="line">#是否需要额外存储</span><br><span class="line">&quot;store&quot;:false</span><br><span class="line">&#125;,</span><br><span class="line">&quot;author&quot;:&#123;</span><br><span class="line">&quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;count&quot;:&#123;</span><br><span class="line">&quot;type&quot;:&quot;long&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;on-sale&quot;:&#123;</span><br><span class="line">&quot;type&quot;:&quot;date&quot;,</span><br><span class="line">#指定时间类型的格式化方式</span><br><span class="line">&quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;descr&quot;:&#123;</span><br><span class="line">&quot;type&quot;:&quot;text&quot;,</span><br><span class="line">&quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="2-3-数据类型"><a href="#2-3-数据类型" class="headerlink" title="2.3 数据类型"></a>2.3 数据类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">字符串类型:</span><br><span class="line">  text: 一般用于全文检索，将当前field 进行分词</span><br><span class="line">  keyword:当前field  不会进行分词</span><br><span class="line">数值类型：</span><br><span class="line">  long:</span><br><span class="line">  Intger:</span><br><span class="line">  short:</span><br><span class="line">  byte:</span><br><span class="line">  double:</span><br><span class="line">  float:</span><br><span class="line">  half_float: 精度比float 小一半</span><br><span class="line">  scaled_float:根据一个long 和scaled 来表达一个浮点型 long-345, -scaled 100 -&gt;3.45</span><br><span class="line">时间类型：</span><br><span class="line">  date类型,根据时间类型指定具体的格式</span><br><span class="line">    PUT my_index</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;_doc&quot;: &#123;</span><br><span class="line">          &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;date&quot;: &#123;</span><br><span class="line">              &quot;type&quot;:   &quot;date&quot;,</span><br><span class="line">              &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">布尔类型：</span><br><span class="line">  boolean 类型，表达true 和false</span><br><span class="line">二进制类型：</span><br><span class="line">  binary类型暂时支持Base64编码的字符串</span><br><span class="line">范围类型：</span><br><span class="line">  integer_range：</span><br><span class="line">  float_range：</span><br><span class="line">  long_range：赋值时，无需指定具体的内容，只需存储一个范围即可，gte,lte,gt,lt,</span><br><span class="line">  double_range：</span><br><span class="line">  date_range：</span><br><span class="line">  ip_range：</span><br><span class="line">    PUT range_index</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot;: 2</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;_doc&quot;: &#123;</span><br><span class="line">          &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;expected_attendees&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;integer_range&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;time_frame&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;date_range&quot;, </span><br><span class="line">              &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    PUT range_index&#x2F;_doc&#x2F;1?refresh</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expected_attendees&quot; : &#123; </span><br><span class="line">        &quot;gte&quot; : 10,</span><br><span class="line">        &quot;lte&quot; : 20</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;time_frame&quot; : &#123; </span><br><span class="line">        &quot;gte&quot; : &quot;2015-10-31 12:00:00&quot;, </span><br><span class="line">        &quot;lte&quot; : &quot;2015-11-01&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">经纬度类型：</span><br><span class="line">  geo_point:用来存储经纬度</span><br><span class="line">IP类型：</span><br><span class="line">  ip:可以存储IPV4 和IPV6</span><br></pre></td></tr></table></figure>
<h4 id="2-4-创建文档"><a href="#2-4-创建文档" class="headerlink" title="2.4 创建文档"></a>2.4 创建文档</h4><p>ES 中的文档相当于 MySQL 数据库表中的记录。</p>
<p>发送：put 或 Post<a target="_blank" rel="noopener" href="http://localhost:9200/xc_course/doc/id%E5%80%BC">http://localhost:9200/xc_course/doc/id值</a></p>
<p>（如果不指定 id 值 ES 会自动生成 ID）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;Bootstrap开发框架&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;Bootstrap是由Twitter推出的一个前台页面开发框架，在行业之中使用较为广泛。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发程序人员）轻松的实现一个不受浏览器限制的精美界面效果。&quot;,</span><br><span class="line">    &quot;studymodel&quot;: &quot;201001&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-5-简单搜索"><a href="#2-5-简单搜索" class="headerlink" title="2.5 简单搜索"></a>2.5 简单搜索</h4><p>1、根据课程 id 查询文档</p>
<p>发送：get<a target="_blank" rel="noopener" href="http://localhost:9200/xc_course/doc/1"> http://localhost:9200/xc_course/doc/1</a></p>
<p>2、查询所有记录</p>
<p>发送 get<a target="_blank" rel="noopener" href="http://localhost:9200/xc_course/doc/_search">http://localhost:9200/xc_course/doc/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123; <span class="attr">&quot;match_all&quot;</span>: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、查询名称中包括 spring 关键字的的记录<br>发送：get<a target="_blank" rel="noopener" href="http://localhost:9200/xc_course/doc/_search?q=name:bootstrap">http://localhost:9200/xc_course/doc/_search?q=name:bootstrap</a></p>
<p>4、查询学习模式为 201001 的记录</p>
<p>发送 get<a target="_blank" rel="noopener" href="http://localhost:9200/xc_course/doc/_search?q=studymodel:201001">http://localhost:9200/xc_course/doc/_search?q=studymodel:201001</a></p>
<p>查询结果分析</p>
<p>分析上边查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">63</span>,<span class="comment">// 耗费的时间</span></span><br><span class="line">  <span class="comment">// 是否超时了，默认情况下不存在time_out,比如你的搜索耗时1分钟，它就等1分钟，但是不超时</span></span><br><span class="line">  <span class="comment">// 在发送搜索请求时可以指定超时时间</span></span><br><span class="line">  <span class="comment">// 比如你指定了10ms超时，它就会把这10ms内获得的数据返回给你</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123; <span class="comment">// 你的搜索请求打到了几个shard上面去。</span></span><br><span class="line">    <span class="comment">// Primary Shard可以承接读、写流量。Replica Shard会承接读流量。</span></span><br><span class="line">    <span class="comment">// 因为我是默认配置，有五个primary shard。</span></span><br><span class="line">    <span class="comment">// 所以它的搜索请求会被打到5个分片上去，并且都成功了</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,<span class="comment">// 跳过了0个</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span> <span class="comment">// 失败了0个</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;<span class="comment">//命中的情况</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1000</span>,<span class="comment">// 命中率 1000个</span></span><br><span class="line">    <span class="comment">// _score 全文检索时使用，这个相关性得分越高，说明doc和检索的内容的越相关、越匹配</span></span><br><span class="line">    <span class="comment">// max_score就是最大的 _score</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// 默认查询前10条，直接返回每个doc的完整数据</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [ &#123;   </span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;bank&quot;</span>,<span class="comment">// 索引</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,<span class="comment">// type</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;0&quot;</span>,<span class="comment">// id </span></span><br><span class="line">      <span class="attr">&quot;sort&quot;</span>: [<span class="number">0</span>],</span><br><span class="line">      <span class="attr">&quot;_score&quot;</span> : <span class="literal">null</span>,<span class="comment">// 相关性得分</span></span><br><span class="line">      <span class="comment">// _source里面存放的是doc的具体数据</span></span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : 		&#123;<span class="attr">&quot;account_number&quot;</span>:<span class="number">0</span>,</span><br><span class="line">                       <span class="attr">&quot;balance&quot;</span>:<span class="number">16623</span>,</span><br><span class="line">                       <span class="attr">&quot;firstname&quot;</span>:<span class="string">&quot;Bradshaw&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;lastname&quot;</span>:<span class="string">&quot;Mckenzie&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;age&quot;</span>:<span class="number">29</span>,</span><br><span class="line">                       <span class="attr">&quot;gender&quot;</span>:<span class="string">&quot;F&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;244 Columbus Place&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;employer&quot;</span>:<span class="string">&quot;Euron&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;bradshawmckenzie@euron.com&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;city&quot;</span>:<span class="string">&quot;Hobucken&quot;</span>,</span><br><span class="line">                       <span class="attr">&quot;state&quot;</span>:<span class="string">&quot;CO&quot;</span>&#125;</span><br><span class="line">    		&#125;,</span><br><span class="line">		 &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;bank&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sort&quot;</span>: [<span class="number">1</span>],</span><br><span class="line">      <span class="attr">&quot;_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : &#123;<span class="attr">&quot;account_number&quot;</span>:<span class="number">1</span>,</span><br><span class="line">                   <span class="attr">&quot;balance&quot;</span>:<span class="number">39225</span>,</span><br><span class="line">                   <span class="attr">&quot;firstname&quot;</span>:<span class="string">&quot;Amber&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;lastname&quot;</span>:<span class="string">&quot;Duke&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;age&quot;</span>:<span class="number">32</span>,</span><br><span class="line">                   <span class="attr">&quot;gender&quot;</span>:<span class="string">&quot;M&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;880 Holmes Lane&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;employer&quot;</span>:<span class="string">&quot;Pyrami&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;amberduke@pyrami.com&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;city&quot;</span>:<span class="string">&quot;Brogan&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;state&quot;</span>:<span class="string">&quot;IL&quot;</span>&#125;</span><br><span class="line">    &#125;, ...</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>took：本次操作花费的时间，单位为毫秒。</li>
<li>timed_out：请求是否超时</li>
<li>_shards：说明本次操作共搜索了哪些分片</li>
<li>hits：搜索命中的记录</li>
<li>hits.total： 符合条件的文档总数 hits.hits：匹配度较高的前 N 个文档</li>
<li>hits.max_score：文档匹配得分，这里为最高分</li>
<li>_score：每个文档都有一个匹配度得分，按照降序排列。</li>
<li>_source：显示了文档的原始内容。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-6更新映射"><a href="#2-6更新映射" class="headerlink" title="2.6更新映射"></a>2.6更新映射</h4><p>映射创建成功可以添加新字段，已有字段不允许更新。</p>
<h4 id="2-7-删除映射"><a href="#2-7-删除映射" class="headerlink" title="2.7 删除映射"></a>2.7 删除映射</h4><p>通过删除索引来删除映射。</p>
<h4 id="2-8-常用映射类型"><a href="#2-8-常用映射类型" class="headerlink" title="2.8 常用映射类型"></a>2.8 常用映射类型</h4><ul>
<li>text 文本字段<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;studymodel&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
字符串包括 text 和 keyword 两种类型：</li>
<li>text</li>
<li>analyzer</li>
</ul>
<p>通过 analyzer 属性指定分词器。</p>
<p>下边指定 name 的字段类型为 text，使用 ik 分词器的 ik_max_word 分词模式。</p>
<p>上边指定了 analyzer 是指在索引和搜索都使用 ik_max_word，如果单独想定义搜索时使用的分词器则可以通过</p>
<p>search_analyzer 对于 ik 分词器建议是索引时使用 ik_max_word 将搜索内容进行细粒分词，搜索时使用 ik_smart 提高搜索精确性。</p>
<ul>
<li>index通过 index 属性指定是否索引。默认为 index=true，即要进行索引，只有进行索引以从索引库搜索到。但是也有一些内容不需要索引，比如：商品图片地址只被用来展示图片，不进行搜索图片，此时可以将 index 设置为 false。</li>
</ul>
<p>删除索引，重新创建映射，将 pic 的 index 设置为 false，尝试根据 pic 去搜索，结果搜索不到数据</p>
<ul>
<li>store是否在 source 之外存储，每个文档索引后会在 ES 中保存一份原始文档，存放在”_source”中，一般情况下不需要设置store 为 true，因为在_source 中已经有一份原始文<h3 id="3-数据类型"><a href="#3-数据类型" class="headerlink" title="3.数据类型"></a>3.数据类型</h3></li>
</ul>
<h4 id="1-keyword-关键字字段"><a href="#1-keyword-关键字字段" class="headerlink" title="1 keyword 关键字字段"></a>1 keyword 关键字字段</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;studymodel&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上边介绍的 text 文本字段在映射时要设置分词器，keyword 字段为关键字字段，通常搜索 keyword 是按照整体搜</p>
<p>索，所以创建 keyword 字段的索引时是不进行分词的，比如：邮政编码、手机号码、身份证等。keyword 字段通常用于过虑、排序、聚合等。</p>
<h4 id="2-date-日期类型"><a href="#2-date-日期类型" class="headerlink" title="2 date 日期类型"></a>2 date 日期类型</h4><p>日期类型不用设置分词器。通常日期类型的字段用于排序。通过 format 设置日期格式</p>
<p>例子：下边的设置允许 date 字段存储年月日时分秒、年月日及毫秒三种格式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy‐MM‐dd HH:mm:ss||yyyy‐MM‐dd&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;3</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;spring开发基础&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">    &quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">    &quot;pic&quot;: &quot;group1&#x2F;M00&#x2F;00&#x2F;01&#x2F;wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg&quot;,</span><br><span class="line">    &quot;timestamp&quot;: &quot;2018‐07‐04 18:28:58&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-数值类型"><a href="#3-数值类型" class="headerlink" title="3 数值类型"></a>3 数值类型</h4><p>1、尽量选择范围小的类型，提高搜索效率</p>
<p>2、对于浮点数尽量用比例因子，比如一个价格字段，单位为元，我们将比例因子设置为100这在ES中会按 分 存 储，映射如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;price&quot;: &#123; &quot;type&quot;: &quot;scaled_float&quot;, &quot;scaling_factor&quot;: 100 &#125;, </span><br></pre></td></tr></table></figure>
<p>由于比例因子为100，如果我们输入的价格是23.45则ES中会将23.45乘以100存储在ES中。 如果输入的价格是23.456，ES会将23.456乘以100再取一个接近原始值的数，得出2346。 使用比例因子的好处是整型比浮点型更易压缩，节省磁盘空间。 如果比例因子不适合，则从下表选择范围小的去用：<br><img src="https://uploader.shimo.im/f/FwDlpWAbcjHhpGz5.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
<h4 id="4-综合"><a href="#4-综合" class="headerlink" title="4 综合"></a>4 综合</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;pic&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;studymodel&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy‐MM‐dd HH:mm:ss||yyyy‐MM‐dd||epoch_millis&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-ES客户端"><a href="#4-ES客户端" class="headerlink" title="4.ES客户端"></a>4.ES客户端</h3><p>ES提供多种不同的客户端：</p>
<p>1、TransportClient ES提供的传统客户端，官方计划8.0版本删除此客户端。</p>
<p>2、RestClient RestClient是官方推荐使用的，它包括两种：Java Low Level REST Client和 Java High Level REST Client。 ES在6.0之后提供 Java High Level REST Client， 两种客户端官方更推荐使用 Java High Level REST Client，不过当 前它还处于完善中，有些功能还没有。  3添加RestHighLevelClient依赖及junit依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch‐rest‐high‐level‐client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xuecheng.elasticsearch.hostlist&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hostlist;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span> </span>&#123; <span class="comment">//解析hostlist配置信息</span></span><br><span class="line">        String[] split = hostlist.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="comment">//创建HttpHost数组，其中存放es主机和端口的配置信息</span></span><br><span class="line">        HttpHost[] httpHostArray = <span class="keyword">new</span> HttpHost[split.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; split.length; i++) &#123;</span><br><span class="line">            String item = split[i];</span><br><span class="line">            httpHostArray[i] = <span class="keyword">new</span> HttpHost(item.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>], Integer.parseInt(item.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">                    [<span class="number">1</span>]), <span class="string">&quot;http&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//创建RestHighLevelClient客户端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(RestClient.builder(httpHostArray));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//项目主要使用RestHighLevelClient，对于低级的客户端暂时不用</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestClient <span class="title">restClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//解析hostlist配置信息</span></span><br><span class="line">        String[] split = hostlist.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="comment">//创建HttpHost数组，其中存放es主机和端口的配置信息</span></span><br><span class="line">        HttpHost[] httpHostArray = <span class="keyword">new</span> HttpHost[split.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; split.length; i++) &#123;</span><br><span class="line">            String item = split[i];</span><br><span class="line">            httpHostArray[i] = <span class="keyword">new</span> HttpHost(item.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>], Integer.parseInt(item.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">                    [<span class="number">1</span>]), <span class="string">&quot;http&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestClient.builder(httpHostArray).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建索引库"><a href="#创建索引库" class="headerlink" title="创建索引库"></a>创建索引库</h4><ul>
<li>API 创建索引： put<a target="_blank" rel="noopener" href="http://localhost:9200/%E7%B4%A2%E5%BC%95%E5%90%8D%E7%A7%B0">http://localhost:9200/索引名称</a>创建映射： 发送：</li>
</ul>
<p>put</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9200/索引库名称/类型名称/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建类型为xc_course的映射，共包括三个字段：name、description、studymodel</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9200/xc_course/doc/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;studymodel&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy‐MM‐dd HH:mm:ss||yyyy‐MM‐dd||epoch_millis&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Java Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIndex</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestClient restClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建索引库</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//创建索引请求对象，并设置索引名称</span></span><br><span class="line">        CreateIndexRequest createIndexRequest = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line"><span class="comment">//设置索引参数</span></span><br><span class="line">        createIndexRequest.settings(Settings.builder().put(<span class="string">&quot;number_of_shards&quot;</span>, <span class="number">1</span>)</span><br><span class="line">                .put(<span class="string">&quot;number_of_replicas&quot;</span>, <span class="number">0</span>));</span><br><span class="line"><span class="comment">//设置映射</span></span><br><span class="line">        createIndexRequest.mapping(<span class="string">&quot;doc&quot;</span>, <span class="string">&quot; &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \t\&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;name\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;analyzer\&quot;:\&quot;ik_max_word\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;search_analyzer\&quot;:\&quot;ik_smart\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;description\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;analyzer\&quot;:\&quot;ik_max_word\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;search_analyzer\&quot;:\&quot;ik_smart\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;studymodel\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;price\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;type\&quot;: \&quot;float\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>, XContentType.JSON);</span><br><span class="line"><span class="comment">//创建索引操作客户端</span></span><br><span class="line">        IndicesClient indices = client.indices();</span><br><span class="line"><span class="comment">//创建响应对象</span></span><br><span class="line">        CreateIndexResponse createIndexResponse = indices.create(createIndexRequest);</span><br><span class="line"><span class="comment">//得到响应结果</span></span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = createIndexResponse.isAcknowledged();</span><br><span class="line">        System.out.println(acknowledged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除索引库</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line"><span class="comment">//删除索引</span></span><br><span class="line">        DeleteIndexResponse deleteIndexResponse = client.indices().delete(deleteIndexRequest);</span><br><span class="line"><span class="comment">//删除索引响应结果</span></span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = deleteIndexResponse.isAcknowledged();</span><br><span class="line">        System.out.println(acknowledged);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h4></li>
<li><p>API 格式如下： PUT /{index}/{type}/{id} { “field”: “value”, … } 如果不指定id，ES会自动生成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> put http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;3 </span><br><span class="line"> &#123;</span><br><span class="line">    &quot;name&quot;: &quot;spring cloud实战&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入3.实战SpringBoot 4.注册中心eureka。&quot;,</span><br><span class="line">    &quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">    &quot;price&quot;: 5.6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>Java Client<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddDoc</span><span class="params">()</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line"><span class="comment">//准备json数据</span></span><br><span class="line">Map&lt;String, Object&gt; jsonMap=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">jsonMap.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;spring cloud实战&quot;</span>);</span><br><span class="line">jsonMap.put(<span class="string">&quot;description&quot;</span>,<span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud</span></span><br><span class="line"><span class="string">基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span>);</span><br><span class="line">jsonMap.put(<span class="string">&quot;studymodel&quot;</span>,<span class="string">&quot;201001&quot;</span>);</span><br><span class="line">SimpleDateFormat dateFormat=<span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy‐MM‐dd HH:mm:ss&quot;</span>);</span><br><span class="line">jsonMap.put(<span class="string">&quot;timestamp&quot;</span>,dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">jsonMap.put(<span class="string">&quot;price&quot;</span>,<span class="number">5.6f</span>);</span><br><span class="line"><span class="comment">//索引请求对象</span></span><br><span class="line">IndexRequest indexRequest=<span class="keyword">new</span> IndexRequest(<span class="string">&quot;xc_course&quot;</span>,<span class="string">&quot;doc&quot;</span>);</span><br><span class="line"><span class="comment">//指定索引文档内容</span></span><br><span class="line">indexRequest.source(jsonMap);</span><br><span class="line"><span class="comment">//索引响应对象</span></span><br><span class="line">IndexResponse indexResponse=client.index(indexRequest);</span><br><span class="line"><span class="comment">//获取响应结果</span></span><br><span class="line">DocWriteResponse.Result result=indexResponse.getResult();</span><br><span class="line">System.out.println(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4></li>
</ul>
<p>通过请求Url有两种方法：</p>
<p>1、完全替换 Post：<a target="_blank" rel="noopener" href="http://localhost:9200/xc_test/doc/3">http://localhost:9200/xc_test/doc/3</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;spring cloud实战&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入3.实战SpringBoot 4.注册中心eureka。&quot;,</span><br><span class="line">    &quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">    &quot;price&quot;: 5.6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、局部更新 下边的例子是只更新price字段。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post: http:&#x2F;&#x2F;localhost:9200&#x2F;xc_test&#x2F;doc&#x2F;3&#x2F;_update </span><br><span class="line">&#123; &quot;doc&quot;:&#123;&quot;price&quot;:66.6&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>Java Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDoc</span><span class="params">()</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        UpdateRequest updateRequest=<span class="keyword">new</span> UpdateRequest(<span class="string">&quot;xc_course&quot;</span>,<span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;4028e581617f945f01617f9dabc40000&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; map=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;spring cloud实战&quot;</span>);</span><br><span class="line">        updateRequest.doc(map);</span><br><span class="line">        UpdateResponse update=client.update(updateRequest);</span><br><span class="line">        RestStatus status=update.status();</span><br><span class="line">        System.out.println(status);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><p>根据id删除，格式如下：DELETE /{index}/{type}/{id}</p>
<p>搜索匹配删除，将搜索出来的记录删除，格式如下： POST /{index}/{type}/_delete_by_query 下边是搜索条件例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;201001&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelDoc</span><span class="params">()</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line"><span class="comment">//删除文档id</span></span><br><span class="line">        String id=<span class="string">&quot;eqP_amQBKsGOdwJ4fHiC&quot;</span>;</span><br><span class="line"><span class="comment">//删除索引请求对象</span></span><br><span class="line">        DeleteRequest deleteRequest=<span class="keyword">new</span> DeleteRequest(<span class="string">&quot;xc_course&quot;</span>,<span class="string">&quot;doc&quot;</span>,id);</span><br><span class="line"><span class="comment">//响应对象</span></span><br><span class="line">        DeleteResponse deleteResponse=client.delete(deleteRequest);</span><br><span class="line"><span class="comment">//获取响应结果</span></span><br><span class="line">        DocWriteResponse.Result result=deleteResponse.getResult();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h2 id="搜索管理"><a href="#搜索管理" class="headerlink" title="搜索管理"></a>搜索管理</h2><h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h3><p>创建xc_course索引库。 创建如下映射 post：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;_mapping</span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;description&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">            &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">            &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;pic&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;index&quot;: false</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;studymodel&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;timestamp&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy‐MM‐dd HH:mm:ss||yyyy‐MM‐dd||epoch_millis&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;1 </span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;Bootstrap开发&quot;,</span><br><span class="line">&quot;description&quot;: &quot;Bootstrap是由Twitter推出的一个前台页面开发框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201002&quot;,</span><br><span class="line">&quot;price&quot;:38.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2018‐04‐25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><br><span class="line">&#125;</span><br><span class="line">http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;2</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;java编程基础&quot;,</span><br><span class="line">&quot;description&quot;: &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">&quot;price&quot;:68.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2018‐03‐25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><br><span class="line">&#125;</span><br><span class="line">http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;3</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;spring开发基础&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">    &quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">    &quot;price&quot;: 88.6,</span><br><span class="line">    &quot;timestamp&quot;: &quot;2018‐02‐24 19:11:35&quot;,</span><br><span class="line">    &quot;pic&quot;: &quot;group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查询所有文档"><a href="#查询所有文档" class="headerlink" title="查询所有文档"></a>查询所有文档</h3><p>发送：post<a target="_blank" rel="noopener" href="http://localhost:9200/xc_course/doc/_search">http://localhost:9200/xc_course/doc/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;studymodel&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果说明：</p>
<ul>
<li>took：本次操作花费的时间，单位为毫秒。</li>
<li>timed_out：请求是否超时 _shards：说明本次操作共搜索了哪些分片</li>
<li>hits：搜索命中的记录</li>
<li>hits.total ： 符合条件的文档总数</li>
<li>hits.hits ：匹配度较高的前N个文档</li>
<li>hits.max_score：文档匹配得分，这里为最高分</li>
<li>_score：每个文档都有一个匹配度得分，按照降序排列。</li>
<li>_source：显示了文档的原始内容。</li>
</ul>
<p>JavaClient：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootTest</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">public class TestSearch &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line">    @Autowired</span><br><span class="line">    RestClient restClient;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;搜索type下的全部记录</span><br><span class="line">    @Test</span><br><span class="line">    public void testSearchAll() throws IOException &#123;</span><br><span class="line">        SearchRequest searchRequest &#x3D; new SearchRequest(&quot;xc_course&quot;);</span><br><span class="line">        searchRequest.types(&quot;doc&quot;);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">&#x2F;&#x2F;source源字段过虑</span><br><span class="line">        searchSourceBuilder.fetchSource(new String[]&#123;&quot;name&quot;, &quot;studymodel&quot;&#125;, new String[]&#123;&#125;);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        SearchResponse searchResponse &#x3D; client.search(searchRequest);</span><br><span class="line">        SearchHits hits &#x3D; searchResponse.getHits();</span><br><span class="line">        SearchHit[] searchHits &#x3D; hits.getHits();</span><br><span class="line">        for (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String index &#x3D; hit.getIndex();</span><br><span class="line">            String type &#x3D; hit.getType();</span><br><span class="line">            String id &#x3D; hit.getId();</span><br><span class="line">            float score &#x3D; hit.getScore();</span><br><span class="line">            String sourceAsString &#x3D; hit.getSourceAsString();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap &#x3D; hit.getSourceAsMap();</span><br><span class="line">            String name &#x3D; (String) sourceAsMap.get(&quot;name&quot;);</span><br><span class="line">            String studymodel &#x3D; (String) sourceAsMap.get(&quot;studymodel&quot;);</span><br><span class="line">            String description &#x3D; (String) sourceAsMap.get(&quot;description&quot;);</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h3><p>ES支持分页查询，传入两个参数：from和size。 form：表示起始文档的下标，从0开始。 size：查询的文档数量。 发送：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">post http://localhost:9200/xc_course/doc/_search </span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;studymodel&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        searchRequest.types(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"><span class="comment">//分页查询，设置起始下标，从0开始</span></span><br><span class="line">        searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//每页显示个数</span></span><br><span class="line">        searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//source源字段过虑</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;studymodel&quot;</span>&#125;, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest);</span><br></pre></td></tr></table></figure>
<h3 id="Term-Query-and-terms"><a href="#Term-Query-and-terms" class="headerlink" title="Term Query and terms"></a>Term Query and terms</h3><p>Term Query为精确查询，在搜索时会整体匹配关键字，不再将关键字分词。 发送：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">post http:&#x2F;&#x2F;localhost:9200&#x2F;xc_course&#x2F;doc&#x2F;_search </span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;spring&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_source&quot;: [</span><br><span class="line">        &quot;name&quot;,</span><br><span class="line">        &quot;studymodel&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        searchRequest.types(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;spring&quot;</span>));</span><br><span class="line"><span class="comment">//source源字段过虑</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;studymodel&quot;</span>&#125;, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#terms 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;terms&quot;: &#123;</span><br><span class="line">      &quot;province&quot;: [</span><br><span class="line">        &quot;北京&quot;,</span><br><span class="line">        &quot;晋城&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">public class TermSearch &#123;</span><br><span class="line">    ObjectMapper mapper &#x3D; new ObjectMapper();</span><br><span class="line">    RestHighLevelClient client &#x3D;  EsClient.getClient();</span><br><span class="line">    String index &#x3D; &quot;sms-logs-index&quot;;</span><br><span class="line">    String type&#x3D;&quot;sms-logs-type&quot;;</span><br><span class="line">    @Test</span><br><span class="line">    public void termsSearchTest() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 1.创建request对象</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F; 2.创建查询条件</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        builder.query(QueryBuilders.termsQuery(&quot;province&quot;,&quot;北京&quot;,&quot;晋城&quot;));</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 3.执行查询</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 输出查询结果</span><br><span class="line">        for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsMap());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="根据id精确匹配"><a href="#根据id精确匹配" class="headerlink" title="根据id精确匹配"></a>根据id精确匹配</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post： http://127.0.0.1:9200/xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ids&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;4&quot;</span>,</span><br><span class="line">                <span class="string">&quot;100&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JavaClient:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] split = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>&#125;; List idList = Arrays.asList(split); searchSourceBuilder.query(QueryBuilders.termsQuery(<span class="string">&quot;_id&quot;</span>, idList));</span><br></pre></td></tr></table></figure>
<h3 id="match-Query"><a href="#match-Query" class="headerlink" title="match Query"></a>match Query</h3><p>1、基本使用 match Query即全文检索，它的搜索方式是先将搜索字符串分词，再使用各各词条从索引中搜索。 match query与Term query区别是match query在搜索前先将搜索关键字分词，再拿各各词语去索引中搜索。 发送：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">post http://localhost:9200/xc_course/doc/_search </span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;spring开发&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;or&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>query：搜索的关键字，对于英文关键字如果有多个单词则中间要用半角逗号分隔，而对于中文关键字中间可以用 逗号分隔也可以不用。 operator：or 表示 只要有一个词在文档中出现则就符合条件，and表示每个词都在文档中出现则才符合条件。 上边的搜索的执行过程是：</p>
<p>1、将“spring开发”分词，分为spring、开发两个词</p>
<p>2、再使用spring和开发两个词去匹配索引中搜索。</p>
<p>3、由于设置了operator为or，只要有一个词匹配成功则就返回该文档。</p>
<p>JavaClient：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//根据关键字搜索</span></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMatchQuery</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">            searchRequest.types(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"><span class="comment">//source源字段过虑</span></span><br><span class="line">            searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;studymodel&quot;</span>&#125;, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line"><span class="comment">//匹配关键字</span></span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;spring开</span></span><br><span class="line"><span class="string">                    发&quot;</span>).operator(Operator.OR));</span><br><span class="line">                    searchRequest.source(searchSourceBuilder);</span><br><span class="line">            SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">            SearchHits hits = searchResponse.getHits();</span><br><span class="line">            SearchHit[] searchHits = hits.getHits();</span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">                String index = hit.getIndex();</span><br><span class="line">                String type = hit.getType();</span><br><span class="line">                String id = hit.getId();</span><br><span class="line">                <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">                String sourceAsString = hit.getSourceAsString();</span><br><span class="line">                Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">                String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">                String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">                System.out.println(name);</span><br><span class="line">                System.out.println(studymodel);</span><br><span class="line">                System.out.println(description);</span><br></pre></td></tr></table></figure>
<p>2、minimum_should_match 上边使用的operator = or表示只要有一个词匹配上就得分，如果实现三个词至少有两个词匹配如何实现？ 使用minimum_should_match可以指定文档匹配词的占比： 比如搜索语句如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;spring开发框架&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;80%&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“spring开发框架”会被分为三个词：spring、开发、框架 设置”minimum_should_match”: “80%”表示，三个词在文档的匹配占比为80%，即3*0.8=2.4，向上取整得2，表 示至少有两个词在文档中要匹配成功。 对应的RestClient如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//匹配关键字 MatchQueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(&quot;description&quot;, &quot;前台页面开发框架 架 构&quot;) .minimumShouldMatch(&quot;80%&quot;);//设置匹配占比 searchSourceBuilder.query(matchQueryBuilder);</span></span><br></pre></td></tr></table></figure>
<h3 id="multi-Query"><a href="#multi-Query" class="headerlink" title="multi Query"></a>multi Query</h3><p>上边学习的termQuery和matchQuery一次只能匹配一个Field，multiQuery，一次可以匹配多个字段。 1、基本使用 单项匹配是在一个field中去匹配，多项匹配是拿关键字去多个Field中匹配。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">post http://localhost:9200/xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;spring css&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿关键字 “spring css”去匹配name 和description字段。<br>匹配多个字段时可以提升字段的boost（权重）来提高得分 例子： 提升boost之前，执行下边的查询：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;spring css&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过查询发现Bootstrap排在前边。 提升boost，通常关键字匹配上name的权重要比匹配上description的权重高，这里可以对name的权重提升。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;spring框架&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;name^10&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“name^10” 表示权重提升10倍，执行上边的查询，发现name中包括spring关键字的文档排在前边。<br>JavaClient:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(&quot;spring框架&quot;, &quot;name&quot;, &quot;description&quot;) .minimumShouldMatch(&quot;50%&quot;); multiMatchQueryBuilder.field(&quot;name&quot;,10);//提升boost</span><br></pre></td></tr></table></figure>
<h3 id="布尔查询"><a href="#布尔查询" class="headerlink" title="布尔查询"></a>布尔查询</h3><p>布尔查询对应于Lucene的BooleanQuery查询，实现将多个查询组合起来。 三个参数： must：文档必须匹配must所包括的查询条件，相当于 “AND” should：文档应该匹配should所包括的查询条件其 中的一个或多个，相当于 “OR” must_not：文档不能匹配must_not所包括的该查询条件，相当于“NOT”</p>
<p>分别使用must、should、must_not测试下边的查询： 发送：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:9200/xc_course/doc/_search </span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;studymodel&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;spring框架&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">                            <span class="string">&quot;name^10&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;description&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;201001&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>must：表示必须，多个查询条件必须都满足。（通常使用must） should：表示或者，多个查询条件只要有一个满足即可。 must_not：表示非。<br>JavaClient：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//BoolQuery，将搜索关键字分词，拿分词去索引库搜索</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBoolQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//创建搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        searchRequest.types(<span class="string">&quot;doc&quot;</span>);</span><br><span class="line"><span class="comment">//创建搜索源配置对象</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;pic&quot;</span>, <span class="string">&quot;studymodel&quot;</span>&#125;, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line"><span class="comment">//multiQuery</span></span><br><span class="line">        String keyword = <span class="string">&quot;spring开发框架&quot;</span>;</span><br><span class="line">        MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">&quot;spring框架&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>)</span><br><span class="line">                .minimumShouldMatch(<span class="string">&quot;50%&quot;</span>);</span><br><span class="line">        multiMatchQueryBuilder.field(<span class="string">&quot;name&quot;</span>, <span class="number">10</span>);</span><br><span class="line"><span class="comment">//TermQuery</span></span><br><span class="line">        TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(<span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;201001&quot;</span>);</span><br><span class="line">        <span class="comment">//布尔查询</span></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">        boolQueryBuilder.must(termQueryBuilder);</span><br><span class="line"><span class="comment">//设置布尔查询对象</span></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);<span class="comment">//设置搜索源配置</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            System.out.println(sourceAsMap);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>
<h3 id="过虑器"><a href="#过虑器" class="headerlink" title="过虑器"></a>过虑器</h3><p>过虑是针对搜索的结果进行过虑，过虑器主要判断的是文档是否匹配，不去计算和判断文档的匹配度得分，所以过 虑器性能比查询要高，且方便缓存，推荐尽量使用过虑器去实现查询或者过虑器和查询共同使用。 过虑器在布尔查询中使用，下边是在搜索结果的基础上进行过虑：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;studymodel&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;spring框架&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">                            <span class="string">&quot;name^10&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;description&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;201001&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;gte&quot;</span>: <span class="number">60</span>,</span><br><span class="line">                            <span class="attr">&quot;lte&quot;</span>: <span class="number">100</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>range：范围过虑，保留大于等于60 并且小于等于100的记录。<br>term：项匹配过虑，保留studymodel等于”201001”的记录。 注意：range和term一次只能对一个Field设置范围过虑。</p>
<p>client：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//布尔查询使用过虑器</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFilter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        searchRequest.types(<span class="string">&quot;doc&quot;</span>);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"><span class="comment">//source源字段过虑</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;price&quot;</span>, <span class="string">&quot;description&quot;</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"><span class="comment">//匹配关键字</span></span><br><span class="line">        MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">&quot;spring框</span></span><br><span class="line"><span class="string">                架&quot;</span>, <span class="string">&quot; name&quot;</span>, <span class="string">&quot; description&quot;</span>);</span><br><span class="line"><span class="comment">//设置匹配占比</span></span><br><span class="line">                multiMatchQueryBuilder.minimumShouldMatch(<span class="string">&quot;50%&quot;</span>);</span><br><span class="line"><span class="comment">//提升另个字段的Boost值</span></span><br><span class="line">        multiMatchQueryBuilder.field(<span class="string">&quot;name&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        searchSourceBuilder.query(multiMatchQueryBuilder);</span><br><span class="line"><span class="comment">//布尔查询</span></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        boolQueryBuilder.must(searchSourceBuilder.query());</span><br><span class="line"><span class="comment">//过虑</span></span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;201001&quot;</span>));</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">60</span>).lte(<span class="number">100</span>));</span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String index = hit.getIndex();</span><br><span class="line">            String type = hit.getType();</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>可以在字段上添加一个或多个排序，支持在keyword、date、float等类型上添加，text类型的字段上不允许添加排 序。 过虑0–10元价格范围的文档，并且对结果进行排序，先按studymodel降序，再按价格升序</p>
<p>发送 POST<a target="_blank" rel="noopener" href="http://localhost:9200/xc_course/doc/_search">http://localhost:9200/xc_course/doc/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;studymodel&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;gte&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">&quot;lte&quot;</span>: <span class="number">100</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;studymodel&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;price&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSort</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        searchRequest.types(<span class="string">&quot;doc&quot;</span>);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"><span class="comment">//source源字段过虑</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;price&quot;</span>, <span class="string">&quot;description&quot;</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"><span class="comment">//布尔查询</span></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line"><span class="comment">//过虑</span></span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">0</span>).lte(<span class="number">100</span>));</span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        searchSourceBuilder.sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">&quot;studymodel&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        searchSourceBuilder.sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">&quot;price&quot;</span>).order(SortOrder.ASC));</span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String index = hit.getIndex();</span><br><span class="line">            String type = hit.getType();</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="高亮显示"><a href="#高亮显示" class="headerlink" title="高亮显示"></a>高亮显示</h3><p>高亮显示可以将搜索结果一个或多个字突出显示，以便向用户展示匹配关键字的位置。 在搜索语句中添加highlight即可实现，如下：</p>
<p>Post：<a target="_blank" rel="noopener" href="http://127.0.0.1:9200/xc_course/doc/_search">http://127.0.0.1:9200/xc_course/doc/_search</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;studymodel&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;开发框架&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">                            <span class="string">&quot;name^10&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;description&quot;</span></span><br><span class="line">                        ],</span><br><span class="line">                        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;best_fields&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;gte&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">&quot;lte&quot;</span>: <span class="number">100</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;price&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;&lt;tag1&gt;&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;&lt;/tag2&gt;&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHighlight</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;xc_course&quot;</span>);</span><br><span class="line">        searchRequest.types(<span class="string">&quot;doc&quot;</span>);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"><span class="comment">//source源字段过虑</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;price&quot;</span>, <span class="string">&quot;description&quot;</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"><span class="comment">//匹配关键字</span></span><br><span class="line">        MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">&quot;开发&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">        searchSourceBuilder.query(multiMatchQueryBuilder);</span><br><span class="line"><span class="comment">//布尔查询</span></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        boolQueryBuilder.must(searchSourceBuilder.query());</span><br><span class="line"><span class="comment">//过虑</span></span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">0</span>).lte(<span class="number">100</span>));</span><br><span class="line"><span class="comment">//排序</span></span><br><span class="line">        searchSourceBuilder.sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">&quot;studymodel&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        searchSourceBuilder.sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">&quot;price&quot;</span>).order(SortOrder.ASC));</span><br><span class="line"><span class="comment">//高亮设置</span></span><br><span class="line">        HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">        highlightBuilder.preTags(<span class="string">&quot;&lt;tag&gt;&quot;</span>);<span class="comment">//设置前缀</span></span><br><span class="line">        highlightBuilder.postTags(<span class="string">&quot;&lt;/tag&gt;&quot;</span>);<span class="comment">//设置后缀</span></span><br><span class="line"><span class="comment">// 设置高亮字段</span></span><br><span class="line">        highlightBuilder.fields().add(<span class="keyword">new</span> HighlightBuilder.Field(<span class="string">&quot;name&quot;</span>));</span><br><span class="line"><span class="comment">// highlightBuilder.fields().add(new HighlightBuilder.Field(&quot;description&quot;));</span></span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line"><span class="comment">//名称</span></span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">//取出高亮字段内容</span></span><br><span class="line">            Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">            <span class="keyword">if</span> (highlightFields != <span class="keyword">null</span>) &#123;</span><br><span class="line">                HighlightField nameField = highlightFields.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (nameField != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Text[] fragments = nameField.getFragments();</span><br><span class="line">                    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                    <span class="keyword">for</span> (Text str : fragments) &#123;</span><br><span class="line">                        stringBuffer.append(str.string());</span><br><span class="line">                    &#125;</span><br><span class="line">                    name = stringBuffer.toString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            String index = hit.getIndex();</span><br><span class="line">            String type = hit.getType();</span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="prefix-查询"><a href="#prefix-查询" class="headerlink" title="prefix 查询"></a>prefix 查询</h3><p>前缀查询，可以通过一个关键字去指定一个field 的前缀，从而查询到指定文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#prefix 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    # 前缀匹配，相对于全文检索，前缀匹配是不会对前缀进行分词的。</span><br><span class="line">  # 而且每次匹配都会扫描整个倒排索引，直到扫描完一遍才会停下来</span><br><span class="line">  # 前缀搜索不会计算相关性得分所有的doc的得分都是1</span><br><span class="line">  # 前缀越短能匹配到的doc就越多，性能越不好</span><br><span class="line">    &quot;prefix&quot;: &#123;</span><br><span class="line">      &quot;corpName&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;海&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;your_index&#x2F;your_type&#x2F;_search</span><br><span class="line">&#123;    </span><br><span class="line">  # 前缀搜索 + 添加权重</span><br><span class="line">  &quot;query&quot;: &#123; </span><br><span class="line">    &quot;prefix&quot; : &#123; </span><br><span class="line">  		&quot;name&quot; :  &#123; </span><br><span class="line">  			&quot;value&quot; : &quot;白日梦&quot;, </span><br><span class="line">  			&quot;boost&quot; : 2.0 </span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#match 查询 在这里是什么都查不到的 和上边的prefix 做比较</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;corpName&quot;: &quot;海&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    public  void findByPrefix() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F;  创建request对象</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F;  指定查询条件</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        &#x2F;&#x2F;--------------------------------------------------</span><br><span class="line">        builder.query(QueryBuilders.prefixQuery(&quot;corpName&quot;,&quot;阿&quot;));</span><br><span class="line">        &#x2F;&#x2F;------------------------------------------------------</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 执行</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 输出结果</span><br><span class="line">        for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsMap());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="fuzzy-查询"><a href="#fuzzy-查询" class="headerlink" title="fuzzy 查询"></a>fuzzy 查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">模糊查询，我们可以输入一个字符的大概，ES 可以根据输入的大概去匹配内容。查询结果不稳定</span><br><span class="line">#fuzzy 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;fuzzy&quot;: &#123;</span><br><span class="line">      &quot;corpName&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;腾讯客堂&quot;,</span><br><span class="line">          #指定前边几个字符是不允许出现错误的</span><br><span class="line">        &quot;prefix_length&quot;: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    public  void findByFuzzy() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F;  创建request对象</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F;  指定查询条件</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        &#x2F;&#x2F;--------------------------------------------------</span><br><span class="line">        builder.query(QueryBuilders.fuzzyQuery(&quot;corpName&quot;,&quot;腾讯客堂&quot;).prefixLength(2));</span><br><span class="line">        &#x2F;&#x2F;------------------------------------------------------</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 执行</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 输出结果</span><br><span class="line">        for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsMap());</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="wildcard-查询"><a href="#wildcard-查询" class="headerlink" title="wildcard 查询"></a>wildcard 查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">通配查询，同mysql中的like 是一样的，可以在查询时，在字符串中指定通配符*和占位符？</span><br><span class="line">#wildcard 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;wildcard&quot;: &#123;</span><br><span class="line">      &quot;corpName&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;海尔*&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#wildcard 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;wildcard&quot;: &#123;</span><br><span class="line">      &quot;corpName&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;海尔??&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">public  void findByWildCard() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F;  创建request对象</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F;  指定查询条件</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        &#x2F;&#x2F;--------------------------------------------------</span><br><span class="line">        builder.query(QueryBuilders.wildcardQuery(&quot;corpName&quot;,&quot;海尔*&quot;));</span><br><span class="line">        &#x2F;&#x2F;------------------------------------------------------</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 执行</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 输出结果</span><br><span class="line">        for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsMap());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="搜索推荐-match-phrase-prefix"><a href="#搜索推荐-match-phrase-prefix" class="headerlink" title="搜索推荐 match_phrase_prefix"></a>搜索推荐 match_phrase_prefix</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;    </span><br><span class="line">   <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">      # 前缀匹配（关键字）</span><br><span class="line">      &quot;match_phrase_prefix&quot; : &#123;</span><br><span class="line">        &quot;message&quot; : &#123;</span><br><span class="line">     						# 比如你搜索关注白日梦，经过分词器处理后会得到最后一个词是：“白日梦”</span><br><span class="line">     					  # 然后他会拿着白日梦再发起一次搜索，于是你就可能搜到下面的内容：</span><br><span class="line">                # “关注白日梦的微信公众号”</span><br><span class="line">     						# ”关注白日梦的圈子“</span><br><span class="line">                &quot;query&quot; : &quot;关注白日梦&quot;,</span><br><span class="line">                # 指定前缀最多匹配多少个term，超过这个数量就不在倒排索引中检索了，提升性能</span><br><span class="line">                &quot;max_expansions&quot; : 10,</span><br><span class="line">                # 提高召回率，使用slop调整term persition，贡献得分</span><br><span class="line">                &quot;slop&quot;:10</span><br><span class="line">            &#125;</span><br><span class="line">       &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="rang-查询"><a href="#rang-查询" class="headerlink" title="rang 查询"></a>rang 查询</h3><p>范围查询，只针对数值类型，对一个field 进行大于或者小于的范围指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#rang 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;fee&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 10,</span><br><span class="line">        &quot;lte&quot;: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">public  void findByRang() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F;  创建request对象</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F;  指定查询条件</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        &#x2F;&#x2F;--------------------------------------------------</span><br><span class="line">        builder.query(QueryBuilders.rangeQuery(&quot;fee&quot;).gt(10).lte(30));</span><br><span class="line">        &#x2F;&#x2F;------------------------------------------------------</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 执行</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 输出结果</span><br><span class="line">        for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsMap());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="regexp-查询"><a href="#regexp-查询" class="headerlink" title="regexp 查询"></a>regexp 查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">正则查询，通过你编写的正则表达式去匹配内容</span><br><span class="line">Ps:prefix wildcard  fuzzy 和regexp 查询效率比较低 ,在要求效率比较高时，避免使用</span><br><span class="line">#regexp 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;regexp&quot;: &#123;</span><br><span class="line">      &quot;mobile&quot;: &quot;138[0-9]&#123;8&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">public  void findByRegexp() throws IOException &#123;</span><br><span class="line">    &#x2F;&#x2F;  创建request对象</span><br><span class="line">    SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">    request.types(type);</span><br><span class="line">    &#x2F;&#x2F;  指定查询条件</span><br><span class="line">    SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">    &#x2F;&#x2F;--------------------------------------------------</span><br><span class="line">    builder.query(QueryBuilders.regexpQuery(&quot;mobile&quot;,&quot;138[0-9]&#123;8&#125;&quot;));</span><br><span class="line">    &#x2F;&#x2F;------------------------------------------------------</span><br><span class="line">    request.source(builder);</span><br><span class="line">    &#x2F;&#x2F; 执行</span><br><span class="line">    SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#x2F;&#x2F; 输出结果</span><br><span class="line">    for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">        System.out.println(hit.getSourceAsMap());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="深分页-scrol-l"><a href="#深分页-scrol-l" class="headerlink" title="深分页 scrol l"></a>深分页 scrol l</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">ES 对from +size时又限制的，from +size 之和 不能大于1W,超过后 效率会十分低下</span><br><span class="line">原理：</span><br><span class="line">  from+size  ES查询数据的方式，</span><br><span class="line">  第一步将用户指定的关键词进行分词，</span><br><span class="line">  第二部将词汇去分词库中进行检索，得到多个文档id,</span><br><span class="line">  第三步去各个分片中拉去数据， 耗时相对较长</span><br><span class="line">  第四步根据score 将数据进行排序， 耗时相对较长</span><br><span class="line">  第五步根据from 和size 的值 将部分数据舍弃，</span><br><span class="line">  第六步，返回结果。</span><br><span class="line">  </span><br><span class="line">  scroll +size ES 查询数据的方式</span><br><span class="line">  第一步将用户指定的关键词进行分词，</span><br><span class="line">  第二部将词汇去分词库中进行检索，得到多个文档id,</span><br><span class="line">  第三步，将文档的id放在一个上下文中</span><br><span class="line">  第四步，根据指定的size去ES中检索指定个数数据，拿完数据的文档id,会从上下文中移除</span><br><span class="line">  第五步，如果需要下一页的数据，直接去ES的上下文中找后续内容。</span><br><span class="line">  第六步，循环第四步和第五步</span><br><span class="line">  scroll 不适合做实时查询。</span><br><span class="line">#scroll 查询,返回第一页数据，并将文档id信息存放在ES上下文中，并指定生存时间</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search?scroll&#x3D;1m</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 2,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;fee&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#根据scroll 查询下一页数据</span><br><span class="line">POST _search&#x2F;scroll</span><br><span class="line">&#123;</span><br><span class="line">  &quot;scroll_id&quot;:&quot;DnF1ZXJ5VGhlbkZldGNoAwAAAAAAABbqFk04VlZ1cjlUU2t1eHpsQWNRY1YwWWcAAAAAAAAW7BZNOFZWdXI5VFNrdXh6bEFjUWNWMFlnAAAAAAAAFusWTThWVnVyOVRTa3V4emxBY1FjVjBZZw&#x3D;&#x3D;&quot;,</span><br><span class="line">  &quot;scroll&quot;:&quot;1m&quot;</span><br><span class="line">&#125;</span><br><span class="line">#删除scroll上下文中的数据</span><br><span class="line">DELETE _search&#x2F;scroll&#x2F;DnF1ZXJ5VGhlbkZldGNoAwAAAAAAABchFk04VlZ1cjlUU2t1eHpsQWNRY1YwWWcAAAAAAAAXIBZNOFZWdXI5VFNrdXh6bEFjUWNWMFlnAAAAAAAAFx8WTThWVnVyOVRTa3V4emxBY1FjVjBZZw&#x3D;&#x3D;</span><br><span class="line">public class ScrollSearch &#123;</span><br><span class="line">    ObjectMapper mapper &#x3D; new ObjectMapper();</span><br><span class="line">    RestHighLevelClient client &#x3D;  EsClient.getClient();</span><br><span class="line">    String index &#x3D; &quot;sms-logs-index&quot;;</span><br><span class="line">    String type&#x3D;&quot;sms-logs-type&quot;;</span><br><span class="line">    @Test</span><br><span class="line">    public void scrollSearch() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 1.创建request</span><br><span class="line">        SearchRequest searchRequest &#x3D; new SearchRequest(index);</span><br><span class="line">        searchRequest.types(type);</span><br><span class="line">        &#x2F;&#x2F;  2.指定scroll信息,过期时间</span><br><span class="line">        searchRequest.scroll(TimeValue.timeValueMinutes(1L));</span><br><span class="line">        &#x2F;&#x2F;  3.指定查询条件</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        builder.size(4);</span><br><span class="line">        builder.sort(&quot;fee&quot;, SortOrder.DESC);</span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 4.获取返回结果scrollId,获取source</span><br><span class="line">        SearchResponse response &#x3D; client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">        String scrollId &#x3D; response.getScrollId();</span><br><span class="line">        System.out.println(&quot;-------------首页数据---------------------&quot;);</span><br><span class="line">        for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsMap());</span><br><span class="line">        &#125;</span><br><span class="line">        while (true)&#123;</span><br><span class="line">            &#x2F;&#x2F; 5.创建scroll request</span><br><span class="line">            SearchScrollRequest scrollRequest &#x3D; new SearchScrollRequest(scrollId);</span><br><span class="line">            &#x2F;&#x2F; 6.指定scroll 有效时间</span><br><span class="line">            scrollRequest.scroll(TimeValue.timeValueMinutes(1L));</span><br><span class="line">            &#x2F;&#x2F; 7.执行查询，返回查询结果</span><br><span class="line">            SearchResponse scroll &#x3D; client.scroll(scrollRequest, RequestOptions.DEFAULT);</span><br><span class="line">            &#x2F;&#x2F; 8.判断是否查询到数据，查询到输出</span><br><span class="line">            SearchHit[] searchHits &#x3D;  scroll.getHits().getHits();</span><br><span class="line">            if(searchHits!&#x3D;null &amp;&amp; searchHits.length &gt;0)&#123;</span><br><span class="line">                System.out.println(&quot;-------------下一页数据---------------------&quot;);</span><br><span class="line">                for (SearchHit hit : searchHits) &#123;</span><br><span class="line">                    System.out.println(hit.getSourceAsMap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                &#x2F;&#x2F;  9.没有数据，结束</span><br><span class="line">                System.out.println(&quot;-------------结束---------------------&quot;);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 10.创建 clearScrollRequest</span><br><span class="line">        ClearScrollRequest clearScrollRequest &#x3D; new ClearScrollRequest();</span><br><span class="line">        &#x2F;&#x2F; 11.指定scrollId</span><br><span class="line">        clearScrollRequest.addScrollId(scrollId);</span><br><span class="line">        &#x2F;&#x2F;12.删除scroll</span><br><span class="line">        ClearScrollResponse clearScrollResponse &#x3D; client.clearScroll(clearScrollRequest, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 13.输出结果</span><br><span class="line">        System.out.println(&quot;删除scroll:&quot;+clearScrollResponse.isSucceeded());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="delete-by-query"><a href="#delete-by-query" class="headerlink" title="delete-by-query"></a>delete-by-query</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">根据term,match 等查询方式去删除大量索引</span><br><span class="line">PS:如果你要删除的内容，时index下的大部分数据，推荐创建一个新的index,然后把保留的文档内容，添加到全新的索引</span><br><span class="line">#Delet-by-query 删除</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_delete_by_query</span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;fee&quot;: &#123;</span><br><span class="line">        &quot;lt&quot;: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    public void deleteByQuery() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 1.创建DeleteByQueryRequest</span><br><span class="line">        DeleteByQueryRequest request &#x3D; new DeleteByQueryRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F; 2.指定条件</span><br><span class="line">        request.setQuery(QueryBuilders.rangeQuery(&quot;fee&quot;).lt(20));</span><br><span class="line">        &#x2F;&#x2F; 3.执行</span><br><span class="line">        BulkByScrollResponse response &#x3D; client.deleteByQuery(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 4.输出返回结果</span><br><span class="line">        System.out.println(response.toString());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="boosting-查询"><a href="#boosting-查询" class="headerlink" title="boosting 查询"></a>boosting 查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">boosting 查询可以帮助我们去影响查询后的score</span><br><span class="line">   positive:只有匹配上positive 查询的内容，才会被放到返回的结果集中</span><br><span class="line">   negative: 如果匹配上了positive 也匹配上了negative, 就可以 降低这样的文档score.</span><br><span class="line">   negative_boost:指定系数,必须小于1   0.5 </span><br><span class="line">关于查询时，分数时如何计算的：</span><br><span class="line">	搜索的关键字再文档中出现的频次越高，分数越高</span><br><span class="line">	指定的文档内容越短，分数越高。</span><br><span class="line">	我们再搜索时，指定的关键字也会被分词，这个被分词的内容，被分词库匹配的个数越多，分数就越高。</span><br><span class="line">   </span><br><span class="line">#boosting 查询</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;boosting&quot;: &#123;</span><br><span class="line">      &quot;positive&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;smsContent&quot;: &quot;战士&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      &quot;negative&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;smsContent&quot;: &quot;团队&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative_boost&quot;: 0.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    public void  boostSearch() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F;  1.创建 searchRequest</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F; 2.指定查询条件</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        BoostingQueryBuilder boost &#x3D; QueryBuilders.boostingQuery(</span><br><span class="line">                QueryBuilders.matchQuery(&quot;smsContent&quot;, &quot;战士&quot;),</span><br><span class="line">                QueryBuilders.matchQuery(&quot;smsContent&quot;, &quot;团队&quot;)</span><br><span class="line">        ).negativeBoost(0.2f);</span><br><span class="line">        builder.query(boost);</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F;  3.执行查询</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 4.输出结果</span><br><span class="line">        for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsMap());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ES的聚合查询和mysql 的聚合查询类似，ES的聚合查询相比mysql 要强大得多。ES提供的统计数据的方式多种多样。</span><br><span class="line">#ES 聚合查询的RSTFul 语法</span><br><span class="line">POST &#x2F;index&#x2F;type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot;:&#123;</span><br><span class="line">        &quot;(名字)agg&quot;:&#123;</span><br><span class="line">            &quot;agg_type&quot;:&#123;</span><br><span class="line">                &quot;属性&quot;：&quot;值&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>去重计数聚合查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">去重计数，cardinality 先将返回的文档中的一个指定的field进行去重，统计一共有多少条</span><br><span class="line"># 去重计数 查询 province</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;provinceAgg&quot;: &#123;</span><br><span class="line">      &quot;cardinality&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;province&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    public void aggCardinalityC() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 1.创建request</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F; 2. 指定使用聚合查询方式</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        builder.aggregation(AggregationBuilders.cardinality(&quot;provinceAgg&quot;).field(&quot;province&quot;));</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 3.执行查询</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 4.输出返回结果</span><br><span class="line">        Cardinality agg &#x3D; response.getAggregations().get(&quot;provinceAgg&quot;);</span><br><span class="line">        System.out.println(agg.getValue());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>嵌套聚合，例如对<code>state</code>字段进行聚合，统计出相同<code>state</code>的文档数量，再统计出<code>balance</code>的平均值；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;average_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Copy to clipboard</span><br><span class="line">Error</span><br><span class="line">Copied</span><br></pre></td></tr></table></figure>
<p><img src="https://uploader.shimo.im/f/vZAkpLGIO05RRuhA.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
</li>
<li><p>对聚合搜索的结果进行排序，例如按<code>balance</code>的平均值降序排列；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;average_balance&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;average_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Copy to clipboard</span><br><span class="line">Error</span><br><span class="line">Copied</span><br></pre></td></tr></table></figure>
<p><img src="https://uploader.shimo.im/f/QVI5lK9zxPKY6aQU.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
</li>
<li><p>按字段值的范围进行分段聚合，例如分段范围为<code>age</code>字段的<code>[20,30]``[30,40]``[40,50]</code>，之后按<code>gender</code>统计文档个数和<code>balance</code>的平均值；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_age&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 20,</span><br><span class="line">            &quot;to&quot;: 30</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 30,</span><br><span class="line">            &quot;to&quot;: 40</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 40,</span><br><span class="line">            &quot;to&quot;: 50</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_gender&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;gender.keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;average_balance&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Copy to clipboard</span><br><span class="line">Error</span><br><span class="line">Copied</span><br></pre></td></tr></table></figure>
<p><img src="https://uploader.shimo.im/f/IjpxQLd6oGrMPx02.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
</li>
<li><p>嵌套聚合，例如对<code>state</code>字段进行聚合，统计出相同<code>state</code>的文档数量，再统计出<code>balance</code>的平均值；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;average_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Copy to clipboard</span><br><span class="line">Error</span><br><span class="line">Copied</span><br></pre></td></tr></table></figure>
<p><img src="https://uploader.shimo.im/f/caJcoGuGtgm1DPYc.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
</li>
<li><p>对聚合搜索的结果进行排序，例如按<code>balance</code>的平均值降序排列；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;average_balance&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;average_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Copy to clipboard</span><br><span class="line">Error</span><br><span class="line">Copied</span><br></pre></td></tr></table></figure>
<p><img src="https://uploader.shimo.im/f/15mx3yrtT7fbkssf.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
</li>
<li><p>按字段值的范围进行分段聚合，例如分段范围为<code>age</code>字段的<code>[20,30]``[30,40]``[40,50]</code>，之后按<code>gender</code>统计文档个数和<code>balance</code>的平均值；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_age&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 20,</span><br><span class="line">            &quot;to&quot;: 30</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 30,</span><br><span class="line">            &quot;to&quot;: 40</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 40,</span><br><span class="line">            &quot;to&quot;: 50</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_gender&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;gender.keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;average_balance&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Copy to clipboard</span><br><span class="line">Error</span><br><span class="line">Copied</span><br></pre></td></tr></table></figure>
<p><img src="https://uploader.shimo.im/f/NvahJNUHKcMyansE.png!thumbnail?fileGuid=jp9HGwXrRXtKHDpg" alt="图片"></p>
</li>
</ul>
<p>6.9.2 范围统计</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">统计一定范围内出现的文档个数，比如，针对某一个field 的值再0~100,100~200,200~300 之间文档出现的个数分别是多少</span><br><span class="line">范围统计 可以针对 普通的数值，针对时间类型，针对ip类型都可以响应。</span><br><span class="line">数值 rang    </span><br><span class="line">时间  date_rang     </span><br><span class="line">ip   ip_rang</span><br><span class="line">#针对数值方式的范围统计  from 带等于效果 ，to 不带等于效果</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;agg&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;fee&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: 30</span><br><span class="line">          &#125;,</span><br><span class="line">           &#123;</span><br><span class="line">            &quot;from&quot;: 30,</span><br><span class="line">            &quot;to&quot;: 60</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 60</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#时间方式统计</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;agg&quot;: &#123;</span><br><span class="line">      &quot;date_range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;sendDate&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy&quot;, </span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: &quot;2000&quot;</span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            &quot;from&quot;: &quot;2000&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#ip 方式 范围统计</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;agg&quot;: &#123;</span><br><span class="line">      &quot;ip_range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;ipAddr&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: &quot;127.0.0.8&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: &quot;127.0.0.8&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> public void aggRang() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 1.创建request</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F; 2. 指定使用聚合查询方式</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        builder.aggregation(AggregationBuilders.range(&quot;agg&quot;).field(&quot;fee&quot;)</span><br><span class="line">                            .addUnboundedTo(30)</span><br><span class="line">                            .addRange(30,60)</span><br><span class="line">                            .addUnboundedFrom(60));</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 3.执行查询</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 4.输出返回结果</span><br><span class="line">        Range agg &#x3D; response.getAggregations().get(&quot;agg&quot;);</span><br><span class="line">        for (Range.Bucket bucket : agg.getBuckets()) &#123;</span><br><span class="line">            String key &#x3D; bucket.getKeyAsString();</span><br><span class="line">            Object from &#x3D; bucket.getFrom();</span><br><span class="line">            Object to &#x3D; bucket.getTo();</span><br><span class="line">            long docCount &#x3D; bucket.getDocCount();</span><br><span class="line">            System.out.println(String.format(&quot;key: %s ,from: %s ,to: %s ,docCount: %s&quot;,key,from,to,docCount));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>6.9.3 统计聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">他可以帮你查询指定field 的最大值，最小值，平均值，平方和...</span><br><span class="line">使用 extended_stats</span><br><span class="line">#统计聚合查询 extended_stats</span><br><span class="line">POST &#x2F;sms-logs-index&#x2F;sms-logs-type&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;agg&quot;: &#123;</span><br><span class="line">      &quot;extended_stats&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;fee&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; java实现   </span><br><span class="line">public void aggExtendedStats() throws IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 1.创建request</span><br><span class="line">        SearchRequest request &#x3D; new SearchRequest(index);</span><br><span class="line">        request.types(type);</span><br><span class="line">        &#x2F;&#x2F; 2. 指定使用聚合查询方式</span><br><span class="line">        SearchSourceBuilder builder &#x3D; new SearchSourceBuilder();</span><br><span class="line">        builder.aggregation(AggregationBuilders.extendedStats(&quot;agg&quot;).field(&quot;fee&quot;));</span><br><span class="line">        request.source(builder);</span><br><span class="line">        &#x2F;&#x2F; 3.执行查询</span><br><span class="line">        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        &#x2F;&#x2F; 4.输出返回结果</span><br><span class="line">       ExtendedStats extendedStats &#x3D;  response.getAggregations().get(&quot;agg&quot;);</span><br><span class="line">        System.out.println(&quot;最大值：&quot;+extendedStats.getMaxAsString()+&quot;,最小值：&quot;+extendedStats.getMinAsString());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="图经纬度搜索"><a href="#图经纬度搜索" class="headerlink" title="图经纬度搜索"></a>图经纬度搜索</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#创建一个经纬度索引,指定一个 name ,一个location</span><br><span class="line">PUT &#x2F;map</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 5,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;map&quot;:&#123;</span><br><span class="line">      &quot;properties&quot;:&#123;</span><br><span class="line">        &quot;name&quot;:&#123;</span><br><span class="line">          &quot;type&quot;:&quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;location&quot;:&#123;</span><br><span class="line">          &quot;type&quot;:&quot;geo_point&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#添加测试数据</span><br><span class="line">PUT &#x2F;map&#x2F;map&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;天安门&quot;,</span><br><span class="line">  &quot;location&quot;:&#123;</span><br><span class="line">    &quot;lon&quot;: 116.403694,</span><br><span class="line">    &quot;lat&quot;:39.914492</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT &#x2F;map&#x2F;map&#x2F;2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;百望山&quot;,</span><br><span class="line">  &quot;location&quot;:&#123;</span><br><span class="line">    &quot;lon&quot;: 116.26284,</span><br><span class="line">    &quot;lat&quot;:40.036576</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT &#x2F;map&#x2F;map&#x2F;3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;北京动物园&quot;,</span><br><span class="line">  &quot;location&quot;:&#123;</span><br><span class="line">    &quot;lon&quot;: 116.347352,</span><br><span class="line">    &quot;lat&quot;:39.947468</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ES 的地图检索方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">geo_distance :直线距离检索方式</span><br><span class="line">geo_bounding_box: 以2个点确定一个矩形，获取再矩形内的数据</span><br><span class="line">geo_polygon:以多个点，确定一个多边形，获取多边形的全部数据</span><br></pre></td></tr></table></figure>
<p>基于RESTFul 实现地图检索</p>
<p>geo_distance</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#geo_distance </span><br><span class="line">POST &#x2F;map&#x2F;map&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;geo_distance&quot;:&#123;</span><br><span class="line">        #确定一个点</span><br><span class="line">      &quot;location&quot;:&#123;</span><br><span class="line">        &quot;lon&quot;:116.434739,</span><br><span class="line">        &quot;lat&quot;:39.909843</span><br><span class="line">      &#125;,</span><br><span class="line">      #确定半径</span><br><span class="line">      &quot;distance&quot;:20000,</span><br><span class="line">      #指定形状为圆形</span><br><span class="line">      &quot;distance_type&quot;:&quot;arc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#geo_bounding_box</span><br><span class="line">POST &#x2F;map&#x2F;map&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;geo_bounding_box&quot;:&#123;</span><br><span class="line">      &quot;location&quot;:&#123;</span><br><span class="line">        &quot;top_left&quot;:&#123;</span><br><span class="line">          &quot;lon&quot;:116.327805,</span><br><span class="line">          &quot;lat&quot;:39.95499</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;bottom_right&quot;:&#123;</span><br><span class="line">          &quot;lon&quot;: 116.363162,</span><br><span class="line">          &quot;lat&quot;:39.938395</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#geo_polygon</span><br><span class="line">POST &#x2F;map&#x2F;map&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;geo_polygon&quot;:&#123;</span><br><span class="line">      &quot;location&quot;:&#123;</span><br><span class="line">          # 指定多个点确定 位置</span><br><span class="line">       &quot;points&quot;:[</span><br><span class="line">         &#123;</span><br><span class="line">           &quot;lon&quot;:116.220296,</span><br><span class="line">           &quot;lat&quot;:40.075013</span><br><span class="line">         &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">           &quot;lon&quot;:116.346777,</span><br><span class="line">           &quot;lat&quot;:40.044751</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">           &quot;lon&quot;:116.236106,</span><br><span class="line">           &quot;lat&quot;:39.981533</span><br><span class="line">         &#125; </span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>java 实现 geo_polygon</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    public class GeoDemo &#123;</span><br><span class="line">    RestHighLevelClient client &#x3D;  EsClient.getClient();</span><br><span class="line">    String index &#x3D; &quot;map&quot;;</span><br><span class="line">    String type&#x3D;&quot;map&quot;;</span><br><span class="line">    @Test</span><br><span class="line">    public void  GeoPolygon() throws IOException &#123;</span><br><span class="line">            &#x2F;&#x2F;  1.创建searchRequest</span><br><span class="line">            SearchRequest request  &#x3D; new SearchRequest(index);</span><br><span class="line">            request.types(type);</span><br><span class="line">            &#x2F;&#x2F;  2.指定 检索方式</span><br><span class="line">            SearchSourceBuilder builder &#x3D;  new SearchSourceBuilder();</span><br><span class="line">            List&lt;GeoPoint&gt; points &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">            points.add(new GeoPoint(40.075013,116.220296));</span><br><span class="line">            points.add(new GeoPoint(40.044751,116.346777));</span><br><span class="line">            points.add(new GeoPoint(39.981533,116.236106));</span><br><span class="line">            builder.query(QueryBuilders.geoPolygonQuery(&quot;location&quot;,points));</span><br><span class="line">            request.source(builder);</span><br><span class="line">            &#x2F;&#x2F; 3.执行</span><br><span class="line">            SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            &#x2F;&#x2F; 4.输出结果</span><br><span class="line">            for (SearchHit hit : response.getHits().getHits()) &#123;</span><br><span class="line">                System.out.println(hit.getSourceAsMap());</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7个查询优化技巧"><a href="#7个查询优化技巧" class="headerlink" title="7个查询优化技巧"></a>7个查询优化技巧</h1><h3 id="优化技巧1"><a href="#优化技巧1" class="headerlink" title="优化技巧1"></a>优化技巧1</h3><p>比如我想在name字段中发起全文检索：“赐我白日梦” ，然后呢我还希望优先得到content字段中也有“赐我白日梦” 的doc。于是可以使用下面的查询技巧。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;bool&quot;</span> : &#123;</span><br><span class="line">         <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">                 <span class="attr">&quot;query&quot;</span>:<span class="string">&quot;赐我白日梦&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         # 注意这里使用的是should，不命中也没关系，只要命中，我就给他的权重加倍。</span><br><span class="line">         &quot;should&quot;:[</span><br><span class="line">             &quot;match&quot;:&#123;</span><br><span class="line">                 &quot;content&quot;:&#123;</span><br><span class="line">                     &quot;query&quot;:&quot;赐我白日梦&quot;,</span><br><span class="line">                     &quot;boost&quot;:2</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         ]</span><br><span class="line">       &#125; </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化技巧2"><a href="#优化技巧2" class="headerlink" title="优化技巧2"></a>优化技巧2</h3><p>更换写法，改变占用的权重比例。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 你可以构建一个像下面这样查询</span><br><span class="line"># 其中的java、golang、elasticsearch各占权重比例的1/3</span><br><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;should&quot;</span>:[</span><br><span class="line">      &#123; <span class="attr">&quot;term&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>&#125;&#125;,         # <span class="number">1</span>/<span class="number">3</span></span><br><span class="line">      &#123; <span class="attr">&quot;term&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;golang&quot;</span>&#125;&#125;,       # <span class="number">1</span>/<span class="number">3</span></span><br><span class="line">    &#123; <span class="attr">&quot;term&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;elasticsearch&quot;</span>&#125;&#125; # <span class="number">1</span>/<span class="number">3</span></span><br><span class="line">   ] </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 你可以将写法改成下面这样:</span><br><span class="line"># java、golang的权重依然是1/3</span><br><span class="line"># elasticsearch和python的权重各占1/6</span><br><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;should&quot;</span>:[</span><br><span class="line">      &#123; <span class="attr">&quot;term&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>&#125;&#125;,  # <span class="number">1</span>/<span class="number">3</span></span><br><span class="line">      &#123; <span class="attr">&quot;term&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;golang&quot;</span>&#125;&#125;,  # <span class="number">1</span>/<span class="number">3</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;should&quot;</span>:[</span><br><span class="line">           &#123;<span class="attr">&quot;term&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;elasticsearch&quot;</span>&#125;&#125;,  # <span class="number">1</span>/<span class="number">6</span></span><br><span class="line">           &#123;<span class="attr">&quot;term&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;python&quot;</span>&#125;&#125;</span><br><span class="line">           ]</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   ] </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化技巧3"><a href="#优化技巧3" class="headerlink" title="优化技巧3"></a>优化技巧3</h3><p>第三种: 如果不希望使用相关性得分，使用下面的语法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># ES中默认会将命中的doc按照 _score 排序</span><br><span class="line"># 但是filter不会影响最终的相关性得分，所以它不会贡献_score</span><br><span class="line"># 所以直接像这样query直接包裹filter这种语法都不被支持</span><br><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">       # 关键字</span><br><span class="line">       &quot;filter&quot; : &#123;</span><br><span class="line">         &quot;term&quot; : &#123; &quot;title&quot; : &quot;this&quot;&#125;</span><br><span class="line">     &#125;,</span><br><span class="line">    &quot;boost&quot; : 1.2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 这时你可以像下面这样，使用constant_score包裹filter，然后在发起请求查询</span><br><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">       # 关键字</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">              &quot;term&quot; : &#123; &quot;title&quot; : &quot;this&quot;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;boost&quot; : 1.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化技巧4"><a href="#优化技巧4" class="headerlink" title="优化技巧4"></a>优化技巧4</h3><p> 比如我对title字段进行检索，我希望检索结果中包含”java”，并且我允许检索结果中包含：”golang“ ，但是！如果检索结果中包含”golang“，我希望这个title中包含”golang“的doc的排名能靠后一些。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;boosting&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;positive&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;negative&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">           <span class="attr">&quot;title&quot;</span>:<span class="string">&quot;golang&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       # 使用negative_boost将权重降低，实现让doc的排名靠后。</span><br><span class="line">       &quot;negative_boost&quot;: 0.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="优化技巧6"><a href="#优化技巧6" class="headerlink" title="优化技巧6"></a>优化技巧6</h3><p>第六种: 重打分机制</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123; </span><br><span class="line">       # 首先发起一次全文检索</span><br><span class="line">       &quot;match&quot;:&#123;</span><br><span class="line">           &quot;title&quot;:&#123;</span><br><span class="line">               &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">               &quot;minimum_should_match&quot;:&quot;50%&quot;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       # 对全文检索的结果进行重新打分</span><br><span class="line">       &quot;rescore&quot;:&#123; </span><br><span class="line">           # 对全文检索的前50条进行重新打分</span><br><span class="line">           &quot;window_size&quot;:50，  </span><br><span class="line">           &quot;query&quot;: &#123; </span><br><span class="line">                # 关键字</span><br><span class="line">               &quot;rescore_query&quot;:&#123;</span><br><span class="line">                    # match_phrase + slop 感知 term persition，贡献分数 </span><br><span class="line">                    &quot;match_phrase&quot;:&#123;</span><br><span class="line">                       &quot;title&quot;:&#123;</span><br><span class="line">                           &quot;query&quot;:&quot;java elasticsearch&quot;,</span><br><span class="line">                           &quot;slop&quot;:50</span><br><span class="line">                     &#125;</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化技巧7"><a href="#优化技巧7" class="headerlink" title="优化技巧7"></a>优化技巧7</h3><p>第七种: 提高召回率和精准度的技巧：混用match和match_phrase+slop提高召回率。注意下面的嵌套查询层级 bool、must、should</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET /your_index/your_type/_search</span><br><span class="line">&#123;    </span><br><span class="line">   # 混合使用match和match_phrase 平衡精准度和召回率</span><br><span class="line">   &quot;query&quot;: &#123; </span><br><span class="line">      &quot;bool&quot;: &#123;  </span><br><span class="line">       &quot;must&quot;:  &#123;</span><br><span class="line">           # 全文检索虽然可以匹配到大量的文档，但是它不能控制词条之间的距离</span><br><span class="line">           # 可能i love world在doc1中距离很近，但是它却被ES排在结果集的后面</span><br><span class="line">           # 它的性能比match_phrase和proximity高</span><br><span class="line">           &quot;match&quot;: &#123;</span><br><span class="line">             &quot;title&quot;: &quot;i love world&quot; </span><br><span class="line">           &#125; </span><br><span class="line">        &#125;,</span><br><span class="line">       &quot;should&quot;: &#123;</span><br><span class="line">            # 因为slop有个特性：词条之间间隔的越近，移动的次数越少 最终的得分就越高</span><br><span class="line">           # 于是可以借助match_phrase+slop感知term position的功能</span><br><span class="line">           # 实现为距离相近的doc贡献分数，让它们靠前排列</span><br><span class="line">           &quot;match_phrase&quot;:&#123;</span><br><span class="line">               &quot;title&quot;:&#123;</span><br><span class="line">                   &quot;query&quot;:&quot;i love world&quot;,</span><br><span class="line">                   &quot;slop&quot;:15</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/m7PLNAJdN9dAzq_Nsv6Gqw">https://mp.weixin.qq.com/s/m7PLNAJdN9dAzq_Nsv6Gqw</a></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/04/24/hello-world/" rel="prev" title="Hello World">
                  <i class="fa fa-chevron-left"></i> Hello World
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/04/25/java%E9%9D%A2%E8%AF%95/" rel="next" title="java面试">
                  java面试 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">vivid</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
