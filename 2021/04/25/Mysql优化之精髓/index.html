<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Gemini&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}</script>
<meta name="description" content="为什么要优化 系统的吞吐量瓶颈往往出现在数据库的访问速度上 随着应用程序的运行，数据库的中的数据会越来越多，处理时间会相应变慢 数据是存放在磁盘上的，读写速度无法和内存相比  回到顶部 如何优化 设计数据库时：数据库表、字段的设计，存储引擎 利用好MySQL自身提供的功能，如索引等 横向扩展：MySQL集群、负载均衡、读写分离 SQL语句的优化（收效甚微）  字段设计 字段类型的选择，设计规范">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysql优化之精髓">
<meta property="og:url" content="http://example.com/2021/04/25/Mysql%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B2%BE%E9%AB%93/index.html">
<meta property="og:site_name" content="vivid的博客">
<meta property="og:description" content="为什么要优化 系统的吞吐量瓶颈往往出现在数据库的访问速度上 随着应用程序的运行，数据库的中的数据会越来越多，处理时间会相应变慢 数据是存放在磁盘上的，读写速度无法和内存相比  回到顶部 如何优化 设计数据库时：数据库表、字段的设计，存储引擎 利用好MySQL自身提供的功能，如索引等 横向扩展：MySQL集群、负载均衡、读写分离 SQL语句的优化（收效甚微）  字段设计 字段类型的选择，设计规范">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d1128d261c2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d112ccaa073?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d112e34034c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d1130fbb1db?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d11319dbda2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d11315e8e49?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d114f0f387e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d114fceed18?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d1153de4d9c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d118aeb8ecc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d118bad29a0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d118c4143cd?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d1190c74232?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d119271b5fe?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d119e2a43b0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d11ad608bec?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d11b51f4477?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="article:published_time" content="2021-04-25T14:35:49.000Z">
<meta property="article:modified_time" content="2021-04-25T14:37:50.085Z">
<meta property="article:author" content="vivid">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2020/6/9/17296d1128d261c2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">


<link rel="canonical" href="http://example.com/2021/04/25/Mysql%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B2%BE%E9%AB%93/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2021&#x2F;04&#x2F;25&#x2F;Mysql%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B2%BE%E9%AB%93&#x2F;&quot;,&quot;path&quot;:&quot;2021&#x2F;04&#x2F;25&#x2F;Mysql优化之精髓&#x2F;&quot;,&quot;title&quot;:&quot;Mysql优化之精髓&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Mysql优化之精髓 | vivid的博客</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">vivid的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BC%98%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">为什么要优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">如何优化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E8%AE%BE%E8%AE%A1"><span class="nav-number"></span> <span class="nav-text">字段设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%88%99%EF%BC%9A%E5%B0%BD%E9%87%8F%E4%BD%BF%E7%94%A8%E6%95%B4%E5%9E%8B%E8%A1%A8%E7%A4%BA%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">1.</span> <span class="nav-text">原则：尽量使用整型表示字符串</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8IP"><span class="nav-number">1.1.</span> <span class="nav-text">存储IP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E5%86%85%E9%83%A8%E7%9A%84%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B%EF%BC%88%E5%8D%95%E9%80%89%EF%BC%89%E5%92%8C%E9%9B%86%E5%90%88%EF%BC%88%E5%A4%9A%E9%80%89%EF%BC%89%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.</span> <span class="nav-text">MySQL内部的枚举类型（单选）和集合（多选）类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%88%99%EF%BC%9A%E5%AE%9A%E9%95%BF%E5%92%8C%E9%9D%9E%E5%AE%9A%E9%95%BF%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-number">2.</span> <span class="nav-text">原则：定长和非定长数据类型的选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%91%E9%A2%9D"><span class="nav-number">2.1.</span> <span class="nav-text">金额</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E7%82%B9%E6%95%B0decimal"><span class="nav-number">2.2.</span> <span class="nav-text">定点数decimal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E5%8D%95%E4%BD%8D%E5%A4%A7%E6%95%B0%E9%A2%9D%E9%81%BF%E5%85%8D%E5%87%BA%E7%8E%B0%E5%B0%8F%E6%95%B0"><span class="nav-number">2.3.</span> <span class="nav-text">小单位大数额避免出现小数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%98%E5%82%A8"><span class="nav-number">2.4.</span> <span class="nav-text">字符串存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%88%99%EF%BC%9A%E5%B0%BD%E5%8F%AF%E8%83%BD%E9%80%89%E6%8B%A9%E5%B0%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E6%8C%87%E5%AE%9A%E7%9F%AD%E7%9A%84%E9%95%BF%E5%BA%A6"><span class="nav-number">3.</span> <span class="nav-text">原则：尽可能选择小的数据类型和指定短的长度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%88%99%EF%BC%9A%E5%B0%BD%E5%8F%AF%E8%83%BD%E4%BD%BF%E7%94%A8-not-null"><span class="nav-number">4.</span> <span class="nav-text">原则：尽可能使用 not null</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%88%99%EF%BC%9A%E5%AD%97%E6%AE%B5%E6%B3%A8%E9%87%8A%E8%A6%81%E5%AE%8C%E6%95%B4%EF%BC%8C%E8%A7%81%E5%90%8D%E7%9F%A5%E6%84%8F"><span class="nav-number">5.</span> <span class="nav-text">原则：字段注释要完整，见名知意</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%88%99%EF%BC%9A%E5%8D%95%E8%A1%A8%E5%AD%97%E6%AE%B5%E4%B8%8D%E5%AE%9C%E8%BF%87%E5%A4%9A"><span class="nav-number">6.</span> <span class="nav-text">原则：单表字段不宜过多</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%88%99%EF%BC%9A%E5%8F%AF%E4%BB%A5%E9%A2%84%E7%95%99%E5%AD%97%E6%AE%B5"><span class="nav-number">7.</span> <span class="nav-text">原则：可以预留字段</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E8%A1%A8%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number"></span> <span class="nav-text">关联表的设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="nav-number">1.</span> <span class="nav-text">一对多</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="nav-number">2.</span> <span class="nav-text">多对多</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="nav-number">3.</span> <span class="nav-text">一对一</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8C%83%E5%BC%8F-Normal-Format"><span class="nav-number"></span> <span class="nav-text">范式 Normal Format</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E8%8C%83%E5%BC%8F1NF%EF%BC%9A%E5%AD%97%E6%AE%B5%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="nav-number">1.</span> <span class="nav-text">第一范式1NF：字段原子性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E8%8C%83%E5%BC%8F%EF%BC%9A%E6%B6%88%E9%99%A4%E5%AF%B9%E4%B8%BB%E9%94%AE%E7%9A%84%E9%83%A8%E5%88%86%E4%BE%9D%E8%B5%96"><span class="nav-number">2.</span> <span class="nav-text">第二范式：消除对主键的部分依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E8%8C%83%E5%BC%8F%EF%BC%9A%E6%B6%88%E9%99%A4%E5%AF%B9%E4%B8%BB%E9%94%AE%E7%9A%84%E4%BC%A0%E9%80%92%E4%BE%9D%E8%B5%96"><span class="nav-number">3.</span> <span class="nav-text">第三范式：消除对主键的传递依赖</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E9%80%89%E6%8B%A9"><span class="nav-number"></span> <span class="nav-text">存储引擎选择</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E5%B7%AE%E5%BC%82"><span class="nav-number">1.</span> <span class="nav-text">功能差异</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%B7%AE%E5%BC%82"><span class="nav-number">2.</span> <span class="nav-text">存储差异</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E4%BE%9D%E6%8D%AE"><span class="nav-number">3.</span> <span class="nav-text">选择依据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-number"></span> <span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%A3%80%E7%B4%A2%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">索引检索为什么快？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL%E4%B8%AD%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.</span> <span class="nav-text">MySQL中索引类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86%E8%AF%AD%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">索引管理语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95"><span class="nav-number">3.1.</span> <span class="nav-text">查看索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">3.2.</span> <span class="nav-text">创建索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8%E4%B9%8B%E5%90%8E%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95"><span class="nav-number">3.2.1.</span> <span class="nav-text">创建表之后建立索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%97%B6%E6%8C%87%E5%AE%9A%E7%B4%A2%E5%BC%95"><span class="nav-number">3.2.2.</span> <span class="nav-text">创建表时指定索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">3.3.</span> <span class="nav-text">删除索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92explain"><span class="nav-number">4.</span> <span class="nav-text">执行计划explain</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-number">5.</span> <span class="nav-text">索引使用场景（重点）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#where"><span class="nav-number">5.1.</span> <span class="nav-text">where</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#order-by"><span class="nav-number">5.2.</span> <span class="nav-text">order by</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#join"><span class="nav-number">5.3.</span> <span class="nav-text">join</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E8%A6%86%E7%9B%96"><span class="nav-number">5.4.</span> <span class="nav-text">索引覆盖</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E7%BB%86%E8%8A%82%EF%BC%88%E8%A6%81%E7%82%B9%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">语法细节（要点）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E8%A6%81%E7%8B%AC%E7%AB%8B%E5%87%BA%E7%8E%B0"><span class="nav-number">6.1.</span> <span class="nav-text">字段要独立出现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#like%E6%9F%A5%E8%AF%A2%EF%BC%8C%E4%B8%8D%E8%83%BD%E4%BB%A5%E9%80%9A%E9%85%8D%E7%AC%A6%E5%BC%80%E5%A4%B4"><span class="nav-number">6.2.</span> <span class="nav-text">like查询，不能以通配符开头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E5%8F%AA%E5%AF%B9%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AD%97%E6%AE%B5%E6%9C%89%E6%95%88"><span class="nav-number">6.3.</span> <span class="nav-text">复合索引只对第一个字段有效</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#or%EF%BC%8C%E4%B8%A4%E8%BE%B9%E6%9D%A1%E4%BB%B6%E9%83%BD%E6%9C%89%E7%B4%A2%E5%BC%95%E5%8F%AF%E7%94%A8"><span class="nav-number">6.4.</span> <span class="nav-text">or，两边条件都有索引可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E5%80%BC%EF%BC%8C%E4%B8%8D%E5%AE%B9%E6%98%93%E4%BD%BF%E7%94%A8%E5%88%B0%E7%B4%A2%E5%BC%95"><span class="nav-number">6.5.</span> <span class="nav-text">状态值，不容易使用到索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">7.</span> <span class="nav-text">如何创建索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95"><span class="nav-number">8.</span> <span class="nav-text">前缀索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BTree"><span class="nav-number">8.1.</span> <span class="nav-text">BTree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#B-Tree%E8%81%9A%E7%B0%87%E7%BB%93%E6%9E%84"><span class="nav-number">8.2.</span> <span class="nav-text">B+Tree聚簇结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E7%B4%A2%E5%BC%95"><span class="nav-number">8.3.</span> <span class="nav-text">哈希索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="nav-number"></span> <span class="nav-text">查询缓存</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E5%8C%BA"><span class="nav-number"></span> <span class="nav-text">分区</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hash-field"><span class="nav-number">0.1.</span> <span class="nav-text">hash(field)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key-field"><span class="nav-number">0.2.</span> <span class="nav-text">key(field)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range%E7%AE%97%E6%B3%95"><span class="nav-number">0.3.</span> <span class="nav-text">range算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#list%E7%AE%97%E6%B3%95"><span class="nav-number">0.4.</span> <span class="nav-text">list算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range-list"><span class="nav-number">0.5.</span> <span class="nav-text">range&#x2F;list</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E5%88%86%E5%8C%BA"><span class="nav-number">0.5.1.</span> <span class="nav-text">增加分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%88%86%E5%8C%BA"><span class="nav-number">0.5.2.</span> <span class="nav-text">删除分区</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key-hash"><span class="nav-number">0.6.</span> <span class="nav-text">key&#x2F;hash</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E%E5%88%86%E5%8C%BA"><span class="nav-number">0.6.1.</span> <span class="nav-text">新增分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%80%E6%AF%81%E5%88%86%E5%8C%BA"><span class="nav-number">0.6.2.</span> <span class="nav-text">销毁分区</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B0%B4%E5%B9%B3%E5%88%86%E5%89%B2%E5%92%8C%E5%9E%82%E7%9B%B4%E5%88%86%E5%89%B2"><span class="nav-number"></span> <span class="nav-text">水平分割和垂直分割</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4"><span class="nav-number"></span> <span class="nav-text">集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83"><span class="nav-number">0.1.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="nav-number">0.2.</span> <span class="nav-text">安装和配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">0.3.</span> <span class="nav-text">配置主从节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEmaster"><span class="nav-number">0.3.1.</span> <span class="nav-text">配置master</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEslave"><span class="nav-number">0.3.2.</span> <span class="nav-text">配置slave</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">0.4.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%E3%80%81%E5%AE%9A%E4%B9%89%E4%B8%A4%E7%A7%8D%E8%BF%9E%E6%8E%A5"><span class="nav-number">0.5.</span> <span class="nav-text">方案一、定义两种连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8Spring-AOP"><span class="nav-number">0.6.</span> <span class="nav-text">方案二、使用Spring AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">0.6.1.</span> <span class="nav-text">项目结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">0.6.2.</span> <span class="nav-text">引入依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB"><span class="nav-number">0.6.3.</span> <span class="nav-text">数据类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#spring%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">0.6.4.</span> <span class="nav-text">spring配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mapper%E6%8E%A5%E5%8F%A3%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">0.6.5.</span> <span class="nav-text">mapper接口和配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="nav-number">0.6.6.</span> <span class="nav-text">核心类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RoutingDataSourceImpl"><span class="nav-number">0.6.6.1.</span> <span class="nav-text">RoutingDataSourceImpl</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DataSourceHandler"><span class="nav-number">0.6.6.2.</span> <span class="nav-text">DataSourceHandler</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DataSourceAspect"><span class="nav-number">0.6.6.3.</span> <span class="nav-text">DataSourceAspect</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">0.6.7.</span> <span class="nav-text">测试读写分离</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">负载均衡算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B8%E5%9E%8BSQL"><span class="nav-number"></span> <span class="nav-text">典型SQL</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-number"></span> <span class="nav-text">慢查询日志</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#profile%E4%BF%A1%E6%81%AF"><span class="nav-number"></span> <span class="nav-text">profile信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-number"></span> <span class="nav-text">典型的服务器配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7mysqlslap"><span class="nav-number"></span> <span class="nav-text">压测工具mysqlslap</span></a></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">vivid</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/25/Mysql%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B2%BE%E9%AB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vivid">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="vivid的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Mysql优化之精髓
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-04-25 22:35:49 / 修改时间：22:37:50" itemprop="dateCreated datePublished" datetime="2021-04-25T22:35:49+08:00">2021-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9D%A2%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">面试</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <span id="more"></span>

<h2 id="为什么要优化"><a href="#为什么要优化" class="headerlink" title="为什么要优化"></a>为什么要优化</h2><ul>
<li>系统的吞吐量瓶颈往往出现在数据库的访问速度上</li>
<li>随着应用程序的运行，数据库的中的数据会越来越多，处理时间会相应变慢</li>
<li>数据是存放在磁盘上的，读写速度无法和内存相比</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chengxy-nds/p/12285215.html#_labelTop">回到顶部</a></p>
<h2 id="如何优化"><a href="#如何优化" class="headerlink" title="如何优化"></a>如何优化</h2><ul>
<li>设计数据库时：数据库表、字段的设计，存储引擎</li>
<li>利用好MySQL自身提供的功能，如索引等</li>
<li>横向扩展：MySQL集群、负载均衡、读写分离</li>
<li>SQL语句的优化（收效甚微）</li>
</ul>
<h1 id="字段设计"><a href="#字段设计" class="headerlink" title="字段设计"></a>字段设计</h1><blockquote>
<p>字段类型的选择，设计规范，范式，常见设计案例</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chengxy-nds/p/12285215.html#_labelTop">回到顶部</a></p>
<h2 id="原则：尽量使用整型表示字符串"><a href="#原则：尽量使用整型表示字符串" class="headerlink" title="原则：尽量使用整型表示字符串"></a>原则：尽量使用整型表示字符串</h2><h3 id="存储IP"><a href="#存储IP" class="headerlink" title="存储IP"></a>存储IP</h3><p><code>INET_ATON(str)</code>，address to number</p>
<p><code>INET_NTOA(number)</code>，number to address</p>
<h3 id="MySQL内部的枚举类型（单选）和集合（多选）类型"><a href="#MySQL内部的枚举类型（单选）和集合（多选）类型" class="headerlink" title="MySQL内部的枚举类型（单选）和集合（多选）类型"></a>MySQL内部的枚举类型（单选）和集合（多选）类型</h3><p>但是因为维护成本较高因此不常使用，使用<strong>关联表</strong>的方式来替代<code>enum</code></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chengxy-nds/p/12285215.html#_labelTop">回到顶部</a></p>
<h2 id="原则：定长和非定长数据类型的选择"><a href="#原则：定长和非定长数据类型的选择" class="headerlink" title="原则：定长和非定长数据类型的选择"></a>原则：定长和非定长数据类型的选择</h2><blockquote>
<p>decimal不会损失精度，存储空间会随数据的增大而增大。double占用固定空间，较大数的存储会损失精度。非定长的还有varchar、text</p>
</blockquote>
<h3 id="金额"><a href="#金额" class="headerlink" title="金额"></a>金额</h3><blockquote>
<p>对数据的精度要求较高，小数的运算和存储存在精度问题（不能将所有小数转换成二进制）</p>
</blockquote>
<h3 id="定点数decimal"><a href="#定点数decimal" class="headerlink" title="定点数decimal"></a>定点数decimal</h3><p><code>price decimal(8,2)</code>有2位小数的定点数，定点数支持很大的数（甚至是超过<code>int,bigint</code>存储范围的数）</p>
<h3 id="小单位大数额避免出现小数"><a href="#小单位大数额避免出现小数" class="headerlink" title="小单位大数额避免出现小数"></a>小单位大数额避免出现小数</h3><p>元-&gt;分</p>
<h3 id="字符串存储"><a href="#字符串存储" class="headerlink" title="字符串存储"></a>字符串存储</h3><p>定长<code>char</code>，非定长<code>varchar、text</code>（上限65535，其中<code>varchar</code>还会消耗1-3字节记录长度，而<code>text</code>使用额外空间记录长度）</p>
<h2 id="原则：尽可能选择小的数据类型和指定短的长度"><a href="#原则：尽可能选择小的数据类型和指定短的长度" class="headerlink" title="原则：尽可能选择小的数据类型和指定短的长度"></a>原则：尽可能选择小的数据类型和指定短的长度</h2><h2 id="原则：尽可能使用-not-null"><a href="#原则：尽可能使用-not-null" class="headerlink" title="原则：尽可能使用 not null"></a>原则：尽可能使用 not null</h2><p>非<code>null</code>字段的处理要比<code>null</code>字段的处理高效些！且不需要判断是否为<code>null</code>。</p>
<p><code>null</code>在MySQL中，不好处理，存储需要额外空间，运算也需要特殊的运算符。如<code>select null = null</code>和<code>select null &lt;&gt; null</code>（<code>&lt;&gt;</code>为不等号）有着同样的结果，只能通过<code>is null</code>和<code>is not null</code>来判断字段是否为<code>null</code>。</p>
<p>如何存储？MySQL中每条记录都需要额外的存储空间，表示每个字段是否为<code>null</code>。因此通常使用特殊的数据进行占位，比如<code>int not null default 0</code>、<code>string not null default ‘’</code></p>
<h2 id="原则：字段注释要完整，见名知意"><a href="#原则：字段注释要完整，见名知意" class="headerlink" title="原则：字段注释要完整，见名知意"></a>原则：字段注释要完整，见名知意</h2><h2 id="原则：单表字段不宜过多"><a href="#原则：单表字段不宜过多" class="headerlink" title="原则：单表字段不宜过多"></a>原则：单表字段不宜过多</h2><p>二三十个就极限了</p>
<h2 id="原则：可以预留字段"><a href="#原则：可以预留字段" class="headerlink" title="原则：可以预留字段"></a>原则：可以预留字段</h2><blockquote>
<p>在使用以上原则之前首先要满足业务需求</p>
</blockquote>
<h1 id="关联表的设计"><a href="#关联表的设计" class="headerlink" title="关联表的设计"></a>关联表的设计</h1><blockquote>
<p>外键<code>foreign key</code>只能实现一对一或一对多的映射</p>
</blockquote>
<h2 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h2><p>使用外键</p>
<h2 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h2><p>单独新建一张表将多对多拆分成两个一对多</p>
<h2 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h2><p>如商品的基本信息（<code>item</code>）和商品的详细信息（<code>item_intro</code>），通常使用相同的主键或者增加一个外键字段（<code>item_id</code>）</p>
<h1 id="范式-Normal-Format"><a href="#范式-Normal-Format" class="headerlink" title="范式 Normal Format"></a>范式 Normal Format</h1><blockquote>
<p>数据表的设计规范，一套越来越严格的规范体系（如果需要满足N范式，首先要满足N-1范式）。N</p>
</blockquote>
<h2 id="第一范式1NF：字段原子性"><a href="#第一范式1NF：字段原子性" class="headerlink" title="第一范式1NF：字段原子性"></a>第一范式1NF：字段原子性</h2><p>字段原子性，字段不可再分割。</p>
<blockquote>
<p>关系型数据库，默认满足第一范式</p>
</blockquote>
<p>注意比较容易出错的一点，在一对多的设计中使用逗号分隔多个外键，这种方法虽然存储方便，但不利于维护和索引（比如查找带标签<code>java</code>的文章）</p>
<h2 id="第二范式：消除对主键的部分依赖"><a href="#第二范式：消除对主键的部分依赖" class="headerlink" title="第二范式：消除对主键的部分依赖"></a>第二范式：消除对主键的部分依赖</h2><blockquote>
<p>即在表中加上一个与业务逻辑无关的字段作为主键</p>
</blockquote>
<p>主键：可以唯一标识记录的字段或者字段集合。</p>
<table>
<thead>
<tr>
<th>course_name</th>
<th>course_class</th>
<th>weekday（周几）</th>
<th>course_teacher</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL</td>
<td>教育大楼1525</td>
<td>周一</td>
<td>张三</td>
</tr>
<tr>
<td>Java</td>
<td>教育大楼1521</td>
<td>周三</td>
<td>李四</td>
</tr>
<tr>
<td>MySQL</td>
<td>教育大楼1521</td>
<td>周五</td>
<td>张三</td>
</tr>
</tbody></table>
<p>依赖：A字段可以确定B字段，则B字段依赖A字段。比如知道了下一节课是数学课，就能确定任课老师是谁。于是<strong>周几</strong>和<strong>下一节课</strong>和就能构成复合主键，能够确定去哪个教室上课，任课老师是谁等。但我们常常增加一个<code>id</code>作为主键，而消除对主键的部分依赖。</p>
<p>对主键的部分依赖：某个字段依赖复合主键中的一部分。</p>
<p>解决方案：新增一个独立字段作为主键。</p>
<h2 id="第三范式：消除对主键的传递依赖"><a href="#第三范式：消除对主键的传递依赖" class="headerlink" title="第三范式：消除对主键的传递依赖"></a>第三范式：消除对主键的传递依赖</h2><p>传递依赖：B字段依赖于A，C字段又依赖于B。比如上例中，任课老师是谁取决于是什么课，是什么课又取决于主键<code>id</code>。因此需要将此表拆分为两张表日程表和课程表（独立数据独立建表）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>weekday</th>
<th>course_class</th>
<th>course_id</th>
</tr>
</thead>
<tbody><tr>
<td>1001</td>
<td>周一</td>
<td>教育大楼1521</td>
<td>3546</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>course_id</th>
<th>course_name</th>
<th>course_teacher</th>
</tr>
</thead>
<tbody><tr>
<td>3546</td>
<td>Java</td>
<td>张三</td>
</tr>
</tbody></table>
<p>这样就减少了数据的冗余（即使周一至周日每天都有Java课，也只是<code>course_id:3546</code>出现了7次）</p>
<h1 id="存储引擎选择"><a href="#存储引擎选择" class="headerlink" title="存储引擎选择"></a>存储引擎选择</h1><blockquote>
<p>早期问题：如何选择MyISAM和Innodb？</p>
<p>现在不存在这个问题了，Innodb不断完善，从各个方面赶超MyISAM，也是MySQL默认使用的。</p>
</blockquote>
<p>存储引擎Storage engine：MySQL中的数据、索引以及其他对象是如何存储的，是一套文件系统的实现。</p>
<h2 id="功能差异"><a href="#功能差异" class="headerlink" title="功能差异"></a>功能差异</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Engine</th>
<th>Support</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>InnoDB</td>
<td>DEFAULT</td>
<td><strong>Supports transactions, row-level locking, and foreign keys</strong></td>
</tr>
<tr>
<td>MyISAM</td>
<td>YES</td>
<td><strong>MyISAM storage engine</strong></td>
</tr>
</tbody></table>
<h2 id="存储差异"><a href="#存储差异" class="headerlink" title="存储差异"></a>存储差异</h2><table>
<thead>
<tr>
<th></th>
<th>MyISAM</th>
<th>Innodb</th>
</tr>
</thead>
<tbody><tr>
<td>文件格式</td>
<td>数据和索引是分别存储的，数据<code>.MYD</code>，索引<code>.MYI</code></td>
<td>数据和索引是集中存储的，<code>.ibd</code></td>
</tr>
<tr>
<td>文件能否移动</td>
<td>能，一张表就对应<code>.frm</code>、<code>MYD</code>、<code>MYI</code>3个文件</td>
<td>否，因为关联的还有<code>data</code>下的其它文件</td>
</tr>
<tr>
<td>记录存储顺序</td>
<td>按记录插入顺序保存</td>
<td>按主键大小有序插入</td>
</tr>
<tr>
<td>空间碎片（删除记录并<code>flush table 表名</code>之后，表文件大小不变）</td>
<td>产生。定时整理：使用命令<code>optimize table 表名</code>实现</td>
<td>不产生</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>锁支持（锁是避免资源争用的一个机制，MySQL锁对用户几乎是透明的）</td>
<td>表级锁定</td>
<td>行级锁定、表级锁定，锁定力度小并发能力高</td>
</tr>
</tbody></table>
<blockquote>
<p>锁扩展</p>
<p>表级锁（<code>table-level lock</code>）：<code>lock tables ,... read/write</code>，<code>unlock tables ,...</code>。其中<code>read</code>是共享锁，一旦锁定任何客户端都不可读；<code>write</code>是独占/写锁，只有加锁的客户端可读可写，其他客户端既不可读也不可写。锁定的是一张表或几张表。</p>
<p>行级锁（<code>row-level lock</code>）：锁定的是一行或几行记录。共享锁：<code>select * from  where &lt;条件&gt; LOCK IN SHARE MODE;</code>，对查询的记录增加共享锁；<code>select * from  where &lt;条件&gt; FOR UPDATE;</code>，对查询的记录增加排他锁。这里<strong>值得注意</strong>的是：<code>innodb</code>的行锁，其实是一个子范围锁，依据条件锁定部分范围，而不是就映射到具体的行上，因此还有一个学名：间隙锁。比如<code>select * from stu where id &lt; 20 LOCK IN SHARE MODE</code>会锁定<code>id</code>在<code>20</code>左右以下的范围，你可能无法插入<code>id</code>为<code>18</code>或<code>22</code>的一条新纪录。</p>
</blockquote>
<h2 id="选择依据"><a href="#选择依据" class="headerlink" title="选择依据"></a>选择依据</h2><p>如果没有特别的需求，使用默认的<code>Innodb</code>即可。</p>
<p>MyISAM：以读写插入为主的应用程序，比如博客系统、新闻门户网站。</p>
<p>Innodb：更新（删除）操作频率也高，或者要保证数据的完整性；并发量高，支持事务和外键保证数据完整性。比如OA自动化办公系统。</p>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><blockquote>
<p>关键字与数据的映射关系称为索引（</p>
<p>包含关键字和对应的记录在磁盘中的地址</p>
<p>）。关键字是从数据当中提取的用于标识、检索数据的特定内容。</p>
</blockquote>
<h2 id="索引检索为什么快？"><a href="#索引检索为什么快？" class="headerlink" title="索引检索为什么快？"></a>索引检索为什么快？</h2><ul>
<li><p>关键字相对于数据本身，</p>
<p>数据量小</p>
</li>
<li><p>关键字是</p>
<p>有序</p>
<p>的，二分查找可快速确定位置</p>
</li>
</ul>
<p>图书馆为每本书都加了索引号（类别-楼层-书架）、字典为词语解释按字母顺序编写目录等都用到了索引。</p>
<h2 id="MySQL中索引类型"><a href="#MySQL中索引类型" class="headerlink" title="MySQL中索引类型"></a>MySQL中索引类型</h2><blockquote>
<p><strong>普通索引</strong>（<code>key</code>），<strong>唯一索引</strong>（<code>unique key</code>），<strong>主键索引</strong>（<code>primary key</code>），<strong>全文索引</strong>（<code>fulltext key</code>）</p>
</blockquote>
<p>三种索引的索引方式是一样的，只不过对索引的关键字有不同的限制：</p>
<ul>
<li>普通索引：对关键字没有限制</li>
<li>唯一索引：要求记录提供的关键字不能重复</li>
<li>主键索引：要求关键字唯一且不为null</li>
</ul>
<h2 id="索引管理语法"><a href="#索引管理语法" class="headerlink" title="索引管理语法"></a>索引管理语法</h2><h3 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h3><p><code>show create table 表名</code>：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d1128d261c2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc 表名</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d112ccaa073?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><h4 id="创建表之后建立索引"><a href="#创建表之后建立索引" class="headerlink" title="创建表之后建立索引"></a>创建表之后建立索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">create TABLE user_index(</span><br><span class="line">	id int auto_increment primary key,</span><br><span class="line">	first_name varchar(16),</span><br><span class="line">	last_name VARCHAR(16),</span><br><span class="line">	id_card VARCHAR(18),</span><br><span class="line">	information text</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- 更改表结构</span><br><span class="line">alter table user_index</span><br><span class="line">-- 创建一个first_name和last_name的复合索引，并命名为name</span><br><span class="line">add key name (first_name,last_name),</span><br><span class="line">-- 创建一个id_card的唯一索引，默认以字段名作为索引名</span><br><span class="line">add UNIQUE KEY (id_card),</span><br><span class="line">-- 鸡肋，全文索引不支持中文</span><br><span class="line">add FULLTEXT KEY (information);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><code>show create table user_index</code>：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d112e34034c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h4 id="创建表时指定索引"><a href="#创建表时指定索引" class="headerlink" title="创建表时指定索引"></a>创建表时指定索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE user_index2 (</span><br><span class="line">	id INT auto_increment PRIMARY KEY,</span><br><span class="line">	first_name VARCHAR (16),</span><br><span class="line">	last_name VARCHAR (16),</span><br><span class="line">	id_card VARCHAR (18),</span><br><span class="line">	information text,</span><br><span class="line">	KEY name (first_name, last_name),</span><br><span class="line">	FULLTEXT KEY (information),</span><br><span class="line">	UNIQUE KEY (id_card)</span><br><span class="line">);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>



<h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><p>根据索引名删除普通索引、唯一索引、全文索引：<code>alter table 表名 drop KEY 索引名</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alter table user_index drop KEY name;</span><br><span class="line">alter table user_index drop KEY id_card;</span><br><span class="line">alter table user_index drop KEY information;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>删除主键索引：<code>alter table 表名 drop primary key</code>（因为主键只有一个）。这里值得注意的是，如果主键自增长，那么不能直接执行此操作（自增长依赖于主键索引）：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d1130fbb1db?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>需要取消自增长再行删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alter table user_index</span><br><span class="line">-- 重新定义字段</span><br><span class="line">MODIFY id int,</span><br><span class="line">drop PRIMARY KEY</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>但通常不会删除主键，因为设计主键一定与业务逻辑无关。</p>
<h2 id="执行计划explain"><a href="#执行计划explain" class="headerlink" title="执行计划explain"></a>执行计划explain</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE innodb1 (</span><br><span class="line">	id INT auto_increment PRIMARY KEY,</span><br><span class="line">	first_name VARCHAR (16),</span><br><span class="line">	last_name VARCHAR (16),</span><br><span class="line">	id_card VARCHAR (18),</span><br><span class="line">	information text,</span><br><span class="line">	KEY name (first_name, last_name),</span><br><span class="line">	FULLTEXT KEY (information),</span><br><span class="line">	UNIQUE KEY (id_card)</span><br><span class="line">);</span><br><span class="line">insert into innodb1 (first_name,last_name,id_card,information) values (&#39;张&#39;,&#39;三&#39;,&#39;1001&#39;,&#39;华山派&#39;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>我们可以通过<code>explain selelct</code>来分析SQL语句执行前的执行计划：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d11319dbda2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>由上图可看出此SQL语句是按照主键索引来检索的。</p>
<p>执行计划是：当执行SQL语句时，首先会分析、优化，形成执行计划，在按照执行计划执行。</p>
<h2 id="索引使用场景（重点）"><a href="#索引使用场景（重点）" class="headerlink" title="索引使用场景（重点）"></a>索引使用场景（重点）</h2><h3 id="where"><a href="#where" class="headerlink" title="where"></a>where</h3><p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d11315e8e49?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>上图中，根据<code>id</code>查询记录，因为<code>id</code>字段仅建立了主键索引，因此此SQL执行可选的索引只有主键索引，如果有多个，最终会选一个较优的作为检索的依据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 增加一个没有建立索引的字段</span><br><span class="line">alter table innodb1 add sex char(1);</span><br><span class="line">-- 按sex检索时可选的索引为null</span><br><span class="line">EXPLAIN SELECT * from innodb1 where sex&#x3D;&#39;男&#39;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d114f0f387e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<blockquote>
<p>可以尝试在一个字段未建立索引时，根据该字段查询的效率，然后对该字段建立索引（<code>alter table 表名 add index(字段名)</code>），同样的SQL执行的效率，你会发现查询效率会有明显的提升（数据量越大越明显）。</p>
</blockquote>
<h3 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h3><p>当我们使用<code>order by</code>将查询结果按照某个字段排序时，如果该字段没有建立索引，那么执行计划会将查询出的所有数据使用外部排序（将数据从硬盘分批读取到内存使用内部排序，最后合并排序结果），这个操作是很影响性能的，因为需要将查询涉及到的所有数据从磁盘中读到内存（如果单条数据过大或者数据量过多都会降低效率），更无论读到内存之后的排序了。</p>
<p>但是如果我们对该字段建立索引<code>alter table 表名 add index(字段名)</code>，那么由于索引本身是有序的，因此直接按照索引的顺序和映射关系逐条取出数据即可。而且如果分页的，那么只用<strong>取出索引表某个范围内的索引对应的数据</strong>，而不用像上述那<strong>取出所有数据</strong>进行排序再返回某个范围内的数据。（从磁盘取数据是最影响性能的）</p>
<h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><blockquote>
<p>对<code>join</code>语句匹配关系（<code>on</code>）涉及的字段建立索引能够提高效率</p>
</blockquote>
<h3 id="索引覆盖"><a href="#索引覆盖" class="headerlink" title="索引覆盖"></a>索引覆盖</h3><p>如果要查询的字段都建立过索引，那么引擎会直接在索引表中查询而不会访问原始数据（否则只要有一个字段没有建立索引就会做全表扫描），这叫索引覆盖。因此我们需要尽可能的在<code>select</code>后</p>
<p>只写必要的查询字段</p>
<p>，以增加索引覆盖的几率。</p>
<p>这里值得注意的是不要想着为每个字段建立索引，因为优先使用索引的优势就在于其体积小。</p>
<h2 id="语法细节（要点）"><a href="#语法细节（要点）" class="headerlink" title="语法细节（要点）"></a>语法细节（要点）</h2><blockquote>
<p>在满足索引使用的场景下（<code>where/order by/join on</code>或索引覆盖），索引也不一定被使用</p>
</blockquote>
<h3 id="字段要独立出现"><a href="#字段要独立出现" class="headerlink" title="字段要独立出现"></a>字段要独立出现</h3><p>比如下面两条SQL语句在语义上相同，但是第一条会使用主键索引而第二条不会。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from user where id &#x3D; 20-1;</span><br><span class="line">select * from user where id+1 &#x3D; 20;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>



<h3 id="like查询，不能以通配符开头"><a href="#like查询，不能以通配符开头" class="headerlink" title="like查询，不能以通配符开头"></a>like查询，不能以通配符开头</h3><p>比如搜索标题包含<code>mysql</code>的文章：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from article where title like &#39;%mysql%&#39;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>这种SQL的执行计划用不了索引（<code>like</code>语句匹配表达式以通配符开头），因此只能做全表扫描，效率极低，在实际工程中几乎不被采用。而一般会使用第三方提供的支持中文的全文索引来做。</p>
<p>但是 <strong>关键字查询</strong> 热搜提醒功能还是可以做的，比如键入<code>mysql</code>之后提醒<code>mysql 教程</code>、<code>mysql 下载</code>、<code>mysql 安装步骤</code>等。用到的语句是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from article where title like &#39;mysql%&#39;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>这种<code>like</code>是可以利用索引的（当然前提是<code>title</code>字段建立过索引）。</p>
<h3 id="复合索引只对第一个字段有效"><a href="#复合索引只对第一个字段有效" class="headerlink" title="复合索引只对第一个字段有效"></a>复合索引只对第一个字段有效</h3><p>建立复合索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table person add index(first_name,last_name);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>其原理就是将索引先按照从<code>first_name</code>中提取的关键字排序，如果无法确定先后再按照从<code>last_name</code>提取的关键字排序，也就是说该索引表只是按照记录的<code>first_name</code>字段值有序。</p>
<p>因此<code>select * from person where first_name = ?</code>是可以利用索引的，而<code>select * from person where last_name = ?</code>无法利用索引。</p>
<blockquote>
<p>那么该复合索引的应用场景是什么？</p>
<p>组合查询</p>
</blockquote>
<p>比如对于<code>select * person from first_name = ? and last_name = ?</code>，复合索引就比对<code>first_name</code>和<code>last_name</code>单独建立索引要高效些。很好理解，复合索引首先二分查找与<code>first_name = ?</code>匹配的记录，再在这些记录中二分查找与<code>last_name</code>匹配的记录，只涉及到一张索引表。而分别单独建立索引则是在<code>first_name</code>索引表中二分找出与<code>first_name = ?</code>匹配的记录，再在<code>last_name</code>索引表中二分找出与<code>last_name = ?</code>的记录，两者取交集。</p>
<h3 id="or，两边条件都有索引可用"><a href="#or，两边条件都有索引可用" class="headerlink" title="or，两边条件都有索引可用"></a>or，两边条件都有索引可用</h3><blockquote>
<p>一但有一边无索引可用就会导致整个SQL语句的全表扫描</p>
</blockquote>
<h3 id="状态值，不容易使用到索引"><a href="#状态值，不容易使用到索引" class="headerlink" title="状态值，不容易使用到索引"></a>状态值，不容易使用到索引</h3><p>如性别、支付状态等状态值字段往往只有极少的几种取值可能，这种字段即使建立索引，也往往利用不上。这是因为，一个状态值可能匹配大量的记录，这种情况MySQL会认为利用索引比全表扫描的效率低，从而弃用索引。索引是随机访问磁盘，而全表扫描是顺序访问磁盘，这就好比有一栋20层楼的写字楼，楼底下的索引牌上写着某个公司对应不相邻的几层楼，你去公司找人，与其按照索引牌的提示去其中一层楼没找到再下来看索引牌再上楼，不如从1楼挨个往上找到顶楼。</p>
<h2 id="如何创建索引"><a href="#如何创建索引" class="headerlink" title="如何创建索引"></a>如何创建索引</h2><ul>
<li><p>建立基础索引：在<code>where、order by、join</code>字段上建立索引。</p>
</li>
<li><p>优化，组合索引：基于业务逻辑</p>
<ul>
<li><p>如果条件经常性出现在一起，那么可以考虑将多字段索引升级为</p>
<p>复合索引</p>
</li>
<li><p>如果通过增加个别字段的索引，就可以出现</p>
<p>索引覆盖</p>
<p>，那么可以考虑为该字段建立索引</p>
</li>
<li><p>查询时，不常用到的索引，应该删除掉</p>
</li>
</ul>
</li>
</ul>
<h2 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h2><p>语法：<code>index(field(10))</code>，使用字段值的前10个字符建立索引，默认是使用字段的全部内容建立索引。</p>
<p>前提：前缀的标识度高。比如密码就适合建立前缀索引，因为密码几乎各不相同。</p>
<p>实操的难度</p>
<p>：在于前缀截取的长度。</p>
<p>我们可以利用<code>select count(*)/count(distinct left(password,prefixLen));</code>，通过从调整<code>prefixLen</code>的值（从1自增）查看不同前缀长度的一个平均匹配度，接近1时就可以了（表示一个密码的前<code>prefixLen</code>个字符几乎能确定唯一一条记录）</p>
<p>索引的存储结构</p>
<h3 id="BTree"><a href="#BTree" class="headerlink" title="BTree"></a>BTree</h3><p>btree（多路平衡查找树）是一种广泛应用于</p>
<p>磁盘上实现索引功能</p>
<p>的一种数据结构，也是大多数数据库索引表的实现。</p>
<p>以<code>add index(first_name,last_name)</code>为例：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d114fceed18?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>BTree的一个node可以存储多个关键字，node的大小取决于计算机的文件系统，因此我们可以通过减小索引字段的长度使结点存储更多的关键字。如果node中的关键字已满，那么可以通过每个关键字之间的子节点指针来拓展索引表，但是不能破坏结构的有序性，比如按照<code>first_name</code>第一有序、<code>last_name</code>第二有序的规则，新添加的<code>韩香</code>就可以插到<code>韩康</code>之后。<code>白起 &lt; 韩飞 &lt; 韩康 &lt; 李世民 &lt; 赵奢 &lt; 李寻欢 &lt; 王语嫣 &lt; 杨不悔</code>。这与二叉搜索树的思想是一样的，只不过二叉搜索树的查找效率是<code>log(2,N)</code>（以2为底N的对数），而BTree的查找效率是<code>log(x,N)</code>（其中x为node的关键字数量，可以达到1000以上）。</p>
<p>从<code>log(1000+,N)</code>可以看出，少量的磁盘读取即可做到大量数据的遍历，这也是btree的设计目的。</p>
<h3 id="B-Tree聚簇结构"><a href="#B-Tree聚簇结构" class="headerlink" title="B+Tree聚簇结构"></a>B+Tree聚簇结构</h3><p>聚簇结构（也是在BTree上升级改造的）中，关键字和记录是存放在一起的。</p>
<p>在MySQL中，仅仅只有<code>Innodb</code>的</p>
<p>主键索引为聚簇结构</p>
<p>，其它的索引包括<code>Innodb</code>的非主键索引都是典型的BTree结构。</p>
<h3 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h3><p>在索引被载入内存时，使用哈希结构来存储。</p>
<h1 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h1><blockquote>
<p>缓存<code>select</code>语句的查询结果</p>
</blockquote>
<p>在配置文件中开启缓存</p>
<p>windows上是<code>my.ini</code>，linux上是<code>my.cnf</code></p>
<p>在<code>[mysqld]</code>段中配置<code>query_cache_type</code>：</p>
<ul>
<li><p>0：不开启</p>
</li>
<li><p>1：开启，默认缓存所有，需要在SQL语句中增加<code>select sql-no-cache</code>提示来放弃缓存</p>
</li>
<li><p>2：开启，默认都不缓存，需要在SQL语句中增加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sql-cache</span><br></pre></td></tr></table></figure>

<p>来主动缓存（</p>
<p>常用</p>
<p>）</p>
</li>
</ul>
<p>更改配置后需要重启以使配置生效，重启后可通过<code>show variables like ‘query_cache_type’;</code>来查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;query_cache_type&#39;;</span><br><span class="line">query_cache_type	DEMAND</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>在客户端设置缓存大小</p>
<p>通过配置项<code>query_cache_size</code>来设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;query_cache_size&#39;;</span><br><span class="line">query_cache_size	0</span><br><span class="line"></span><br><span class="line">set global query_cache_size&#x3D;64*1024*1024;</span><br><span class="line">show variables like &#39;query_cache_size&#39;;</span><br><span class="line">query_cache_size	67108864</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>将查询结果缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sql_cache * from user;</span><br></pre></td></tr></table></figure>

<p>重置缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset query cache;</span><br></pre></td></tr></table></figure>

<p>缓存失效问题（大问题）</p>
<p>当数据表改动时，基于该数据表的任何缓存都会被删除。（表层面的管理，不是记录层面的管理，因此失效率较高）</p>
<p>注意事项</p>
<ol>
<li>应用程序，不应该关心<code>query cache</code>的使用情况。可以尝试使用，但不能由<code>query cache</code>决定业务逻辑，因为<code>query cache</code>由DBA来管理。</li>
<li>缓存是以SQL语句为key存储的，因此即使SQL语句功能相同，但如果多了一个空格或者大小写有差异都会导致匹配不到缓存。</li>
</ol>
<h1 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h1><p>一般情况下我们创建的表对应一组存储文件，使用<code>MyISAM</code>存储引擎时是一个<code>.MYI</code>和<code>.MYD</code>文件，使用<code>Innodb</code>存储引擎时是一个<code>.ibd</code>和<code>.frm</code>（表结构）文件。</p>
<p>当数据量较大时（一般千万条记录级别以上），MySQL的性能就会开始下降，这时我们就需要将数据分散到多组存储文件，</p>
<p>保证其单个文件的执行效率</p>
<p>。</p>
<p>最常见的分区方案是按<code>id</code>分区，如下将<code>id</code>的哈希值对10取模将数据均匀分散到10个<code>.ibd</code>存储文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table article(</span><br><span class="line">	id int auto_increment PRIMARY KEY,</span><br><span class="line">	title varchar(64),</span><br><span class="line">	content text</span><br><span class="line">)PARTITION by HASH(id) PARTITIONS 10</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>查看<code>data</code>目录：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d1153de4d9c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<blockquote>
<p>服务端的表分区对于客户端是透明的</p>
<p>，客户端还是照常插入数据，但服务端会按照分区算法分散存储数据。</p>
</blockquote>
<p>MySQL提供的分区算法</p>
<blockquote>
<p>分区依据的字段必须是主键的一部分</p>
<p>，分区是为了快速定位数据，因此该字段的搜索频次较高应作为强检索字段，否则依照该字段分区毫无意义</p>
</blockquote>
<h3 id="hash-field"><a href="#hash-field" class="headerlink" title="hash(field)"></a>hash(field)</h3><p>相同的输入得到相同的输出。输出的结果跟输入是否具有规律无关。</p>
<p>仅适用于整型字段</p>
<h3 id="key-field"><a href="#key-field" class="headerlink" title="key(field)"></a>key(field)</h3><p>和<code>hash(field)</code>的性质一样，只不过<code>key</code>是</p>
<p>处理字符串</p>
<p>的，比<code>hash()</code>多了一步从字符串中计算出一个整型在做取模操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table article_key(</span><br><span class="line">	id int auto_increment,</span><br><span class="line">	title varchar(64),</span><br><span class="line">	content text,</span><br><span class="line">	PRIMARY KEY (id,title)	-- 要求分区依据字段必须是主键的一部分</span><br><span class="line">)PARTITION by KEY(title) PARTITIONS 10</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>



<h3 id="range算法"><a href="#range算法" class="headerlink" title="range算法"></a>range算法</h3><p>是一种</p>
<p>条件分区</p>
<p>算法，按照数据大小范围分区（将数据使用某种条件，分散到不同的分区中）。</p>
<p>如下，按文章的发布时间将数据按照2018年8月、9月、10月分区存放：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table article_range(</span><br><span class="line">	id int auto_increment,</span><br><span class="line">	title varchar(64),</span><br><span class="line">	content text,</span><br><span class="line">	created_time int,	-- 发布时间到1970-1-1的毫秒数</span><br><span class="line">	PRIMARY KEY (id,created_time)	-- 要求分区依据字段必须是主键的一部分</span><br><span class="line">)charset&#x3D;utf8</span><br><span class="line">PARTITION BY RANGE(created_time)(</span><br><span class="line">	PARTITION p201808 VALUES less than (1535731199),	-- select UNIX_TIMESTAMP(&#39;2018-8-31 23:59:59&#39;)</span><br><span class="line">	PARTITION p201809 VALUES less than (1538323199),	-- 2018-9-30 23:59:59</span><br><span class="line">	PARTITION p201810 VALUES less than (1541001599)	-- 2018-10-31 23:59:59</span><br><span class="line">);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d118aeb8ecc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>注意：条件运算符只能使用</p>
<p>less than</p>
<p>，这以为着较小的范围要放在前面，比如上述<code>p201808,p201819,p201810</code>分区的定义顺序依照<code>created_time</code>数值范围从小到大，不能颠倒。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into article_range values(null,&#39;MySQL优化&#39;,&#39;内容示例&#39;,1535731180);</span><br><span class="line">flush tables;	-- 使操作立即刷新到磁盘文件</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d118bad29a0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>由于插入的文章的发布时间<code>1535731180</code>小于<code>1535731199</code>（<code>2018-8-31 23:59:59</code>），因此被存储到<code>p201808</code>分区中，这种算法的存储到哪个分区取决于数据状况。</p>
<h3 id="list算法"><a href="#list算法" class="headerlink" title="list算法"></a>list算法</h3><p>也是一种条件分区，按照列表值分区（<code>in (值列表)</code>）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">create table article_list(</span><br><span class="line">	id int auto_increment,</span><br><span class="line">	title varchar(64),</span><br><span class="line">	content text,</span><br><span class="line">	status TINYINT(1),	-- 文章状态：0-草稿，1-完成但未发布，2-已发布</span><br><span class="line">	PRIMARY KEY (id,status)	-- 要求分区依据字段必须是主键的一部分</span><br><span class="line">)charset&#x3D;utf8</span><br><span class="line">PARTITION BY list(status)(</span><br><span class="line">	PARTITION writing values in(0,1),	-- 未发布的放在一个分区	</span><br><span class="line">	PARTITION published values in (2)	-- 已发布的放在一个分区</span><br><span class="line">);</span><br><span class="line">复制代码</span><br><span class="line">insert into article_list values(null,&#39;mysql优化&#39;,&#39;内容示例&#39;,0);</span><br><span class="line">flush tables;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d118c4143cd?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>分区管理语法</p>
<h3 id="range-list"><a href="#range-list" class="headerlink" title="range/list"></a>range/list</h3><h4 id="增加分区"><a href="#增加分区" class="headerlink" title="增加分区"></a>增加分区</h4><p>前文中我们尝试使用<code>range</code>对文章按照月份归档，随着时间的增加，我们需要增加一个月份：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alter table article_range add partition(</span><br><span class="line">	partition p201811 values less than (1543593599)	-- select UNIX_TIMESTAMP(&#39;2018-11-30 23:59:59&#39;)</span><br><span class="line">	-- more</span><br><span class="line">);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d1190c74232?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h4 id="删除分区"><a href="#删除分区" class="headerlink" title="删除分区"></a>删除分区</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table article_range drop PARTITION p201808</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>删除分区后，分区中原有的数据也会随之删除！</p>
<h3 id="key-hash"><a href="#key-hash" class="headerlink" title="key/hash"></a>key/hash</h3><h4 id="新增分区"><a href="#新增分区" class="headerlink" title="新增分区"></a>新增分区</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table article_key add partition partitions 4</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d119271b5fe?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h4 id="销毁分区"><a href="#销毁分区" class="headerlink" title="销毁分区"></a>销毁分区</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table article_key coalesce partition 6</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><code>key/hash</code>分区的管理不会删除数据，但是每一次调整（新增或销毁分区）都会将所有的数据重写分配到新的分区上。</p>
<p>效率极低</p>
<p>，最好在设计阶段就考虑好分区策略。</p>
<p>分区的使用</p>
<p>当数据表中的数据量很大时，分区带来的效率提升才会显现出来。</p>
<p>只有检索字段为分区字段时，分区带来的效率提升才会比较明显。因此，</p>
<p>分区字段的选择很重要</p>
<p>，并且</p>
<p>业务逻辑要尽可能地根据分区字段做相应调整</p>
<p>（尽量使用分区字段作为查询条件）。</p>
<h1 id="水平分割和垂直分割"><a href="#水平分割和垂直分割" class="headerlink" title="水平分割和垂直分割"></a>水平分割和垂直分割</h1><blockquote>
<p>水平分割：通过建立结构相同的几张表分别存储数据</p>
<p>垂直分割：将经常一起使用的字段放在一个单独的表中，分割后的表记录之间是一一对应关系。</p>
</blockquote>
<p>分表原因</p>
<ul>
<li>为数据库减压</li>
<li>分区算法局限</li>
<li>数据库支持不完善（<code>5.1</code>之后<code>mysql</code>才支持分区操作）</li>
</ul>
<p>id重复的解决方案</p>
<ul>
<li>借用第三方应用如<code>memcache、redis</code>的<code>id</code>自增器</li>
<li>单独建一张只包含<code>id</code>一个字段的表，每次自增该字段作为数据记录的<code>id</code></li>
</ul>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><blockquote>
<p>横向扩展：从根本上（单机的硬件处理能力有限）提升数据库性能 。由此而生的相关技术：</p>
<p>读写分离、负载均衡</p>
</blockquote>
<p>安装和配置主从复制</p>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li><code>Red Hat Enterprise Linux Server release 7.0 (Maipo)</code>（虚拟机）</li>
<li><code>mysql5.7</code>（<a target="_blank" rel="noopener" href="https://mirrors.163.com/mysql/Downloads/MySQL-5.7/mysql-5.7.23-linux-glibc2.12-x86_64.tar.gz">下载地址</a>）</li>
</ul>
<h3 id="安装和配置"><a href="#安装和配置" class="headerlink" title="安装和配置"></a>安装和配置</h3><p>解压到对外提供的服务的目录（我自己专门创建了一个<code>/export/server</code>来存放）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf mysql-5.7.23-linux-glibc2.12-x86_64.tar.gz -C &#x2F;export&#x2F;server</span><br><span class="line">cd &#x2F;export&#x2F;server</span><br><span class="line">mv mysql-5.7.23-linux-glibc2.12-x86_64 mysql</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>添加<code>mysql</code>目录的所属组和所属者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql mysql</span><br><span class="line">cd &#x2F;export&#x2F;server</span><br><span class="line">chown -R mysql:mysql mysql&#x2F;</span><br><span class="line">chmod -R 755 mysql&#x2F;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>创建<code>mysql</code>数据存放目录（其中<code>/export/data</code>是我创建专门用来为各种服务存放数据的目录）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;export&#x2F;data&#x2F;mysql</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>初始化<code>mysql</code>服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;export&#x2F;server&#x2F;mysql</span><br><span class="line">.&#x2F;bin&#x2F;mysqld --basedir&#x3D;&#x2F;export&#x2F;server&#x2F;mysql --datadir&#x3D;&#x2F;export&#x2F;data&#x2F;mysql --user&#x3D;mysql --pid-file&#x3D;&#x2F;export&#x2F;data&#x2F;mysql&#x2F;mysql.pid --initialize</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果成功会显示<code>mysql</code>的<code>root</code>账户的初始密码，记下来以备后续登录。如果报错缺少依赖，则使用<code>yum instally</code>依次安装即可</p>
</blockquote>
<p>配置<code>my.cnf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">basedir&#x3D;&#x2F;export&#x2F;server&#x2F;mysql</span><br><span class="line">datadir&#x3D;&#x2F;export&#x2F;data&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;tmp&#x2F;mysql.sock</span><br><span class="line">user&#x3D;mysql</span><br><span class="line">server-id&#x3D;10 # 服务id，在集群时必须唯一，建议设置为IP的第四段</span><br><span class="line">port&#x3D;3306</span><br><span class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line">symbolic-links&#x3D;0</span><br><span class="line"># Settings user and group are ignored when systemd is used.</span><br><span class="line"># If you need to run mysqld under a different user or group,</span><br><span class="line"># customize your systemd unit file for mariadb according to the</span><br><span class="line"># instructions in http:&#x2F;&#x2F;fedoraproject.org&#x2F;wiki&#x2F;Systemd</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error&#x3D;&#x2F;export&#x2F;data&#x2F;mysql&#x2F;error.log</span><br><span class="line">pid-file&#x3D;&#x2F;export&#x2F;data&#x2F;mysql&#x2F;mysql.pid</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># include all files from the config directory</span><br><span class="line">#</span><br><span class="line">!includedir &#x2F;etc&#x2F;my.cnf.d</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>将服务添加到开机自动启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;export&#x2F;server&#x2F;mysql&#x2F;support-files&#x2F;mysql.server &#x2F;etc&#x2F;init.d&#x2F;mysqld</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service mysqld start</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>配置环境变量，在<code>/etc/profile</code>中添加如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># mysql env</span><br><span class="line">MYSQL_HOME&#x3D;&#x2F;export&#x2F;server&#x2F;mysql</span><br><span class="line">MYSQL_PATH&#x3D;$MYSQL_HOME&#x2F;bin</span><br><span class="line">PATH&#x3D;$PATH:$MYSQL_PATH</span><br><span class="line">export PATH</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>使配置即可生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;etc&#x2F;profile</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>使用<code>root</code>登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line"># 这里填写之前初始化服务时提供的密码</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>登录上去之后，更改<code>root</code>账户密码（我为了方便将密码改为root），否则操作数据库会报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set password&#x3D;password(&#39;root&#39;);</span><br><span class="line">flush privileges;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>设置服务可被所有远程客户端访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">update user set host&#x3D;&#39;%&#39; where user&#x3D;&#39;root&#39;;</span><br><span class="line">flush privileges;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样就可以在宿主机使用<code>navicat</code>远程连接虚拟机linux上的mysql了</p>
</blockquote>
<h3 id="配置主从节点"><a href="#配置主从节点" class="headerlink" title="配置主从节点"></a>配置主从节点</h3><h4 id="配置master"><a href="#配置master" class="headerlink" title="配置master"></a>配置master</h4><p>以<code>linux</code>（<code>192.168.10.10</code>）上的<code>mysql</code>为<code>master</code>，宿主机（<code>192.168.10.1</code>）上的<code>mysql</code>为<code>slave</code>配置主从复制。</p>
<p>修改<code>master</code>的<code>my.cnf</code>如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">basedir&#x3D;&#x2F;export&#x2F;server&#x2F;mysql</span><br><span class="line">datadir&#x3D;&#x2F;export&#x2F;data&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;tmp&#x2F;mysql.sock</span><br><span class="line">user&#x3D;mysql</span><br><span class="line">server-id&#x3D;10</span><br><span class="line">port&#x3D;3306</span><br><span class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line">symbolic-links&#x3D;0</span><br><span class="line"># Settings user and group are ignored when systemd is used.</span><br><span class="line"># If you need to run mysqld under a different user or group,</span><br><span class="line"># customize your systemd unit file for mariadb according to the</span><br><span class="line"># instructions in http:&#x2F;&#x2F;fedoraproject.org&#x2F;wiki&#x2F;Systemd</span><br><span class="line"></span><br><span class="line">log-bin&#x3D;mysql-bin	# 开启二进制日志</span><br><span class="line">expire-logs-days&#x3D;7  # 设置日志过期时间，避免占满磁盘</span><br><span class="line">binlog-ignore-db&#x3D;mysql	# 不使用主从复制的数据库</span><br><span class="line">binlog-ignore-db&#x3D;information_schema</span><br><span class="line">binlog-ignore-db&#x3D;performation_schema</span><br><span class="line">binlog-ignore-db&#x3D;sys</span><br><span class="line">binlog-do-db&#x3D;test	#使用主从复制的数据库</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error&#x3D;&#x2F;export&#x2F;data&#x2F;mysql&#x2F;error.log</span><br><span class="line">pid-file&#x3D;&#x2F;export&#x2F;data&#x2F;mysql&#x2F;mysql.pid</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># include all files from the config directory</span><br><span class="line">#</span><br><span class="line">!includedir &#x2F;etc&#x2F;my.cnf.d</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>重启<code>master</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service mysqld restart</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>登录<code>master</code>查看配置是否生效（<code>ON</code>即为开启，默认为<code>OFF</code>）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;log_bin&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>在<code>master</code>的数据库中建立备份账号：<code>backup</code>为用户名，<code>%</code>表示任何远程地址，用户<code>back</code>可以使用密码<code>1234</code>通过任何远程客户端连接<code>master</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grant replication slave on *.* to &#39;backup&#39;@&#39;%&#39; identified by &#39;1234&#39;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>查看<code>user</code>表可以看到我们刚创建的用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql</span><br><span class="line">mysql&gt; select user,authentication_string,host from user;</span><br><span class="line">+---------------+-------------------------------------------+-----------+</span><br><span class="line">| user          | authentication_string                     | host      |</span><br><span class="line">+---------------+-------------------------------------------+-----------+</span><br><span class="line">| root          | *81F5E21E35407D884A6CD4A731AEBFB6AF209E1B | %         |</span><br><span class="line">| mysql.session | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE | localhost |</span><br><span class="line">| mysql.sys     | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE | localhost |</span><br><span class="line">| backup        | *A4B6157319038724E3560894F7F932C8886EBFCF | %         |</span><br><span class="line">+---------------+-------------------------------------------+-----------+</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>新建<code>test</code>数据库，创建一个<code>article</code>表以备后续测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;article&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;title&#96; varchar(64) DEFAULT NULL,</span><br><span class="line">  &#96;content&#96; text,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) CHARSET&#x3D;utf8;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>重启服务并刷新数据库状态到存储文件中（<code>with read lock</code>表示在此过程中，客户端只能读数据，以便获得一个一致性的快照）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@zhenganwen ~]# service mysqld restart</span><br><span class="line">Shutting down MySQL.... SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS! </span><br><span class="line">[root@zhenganwen mysql]# mysql -uroot -proot</span><br><span class="line">mysql&gt; flush tables with read lock;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>查看<code>master</code>上当前的二进制日志和偏移量（记一下其中的<code>File</code>和<code>Position</code>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000002</span><br><span class="line">         Position: 154</span><br><span class="line">     Binlog_Do_DB: test</span><br><span class="line"> Binlog_Ignore_DB: mysql,information_schema,performation_schema,sys</span><br><span class="line">Executed_Gtid_Set: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d119e2a43b0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p><code>File</code>表示实现复制功能的日志，即上图中的<code>Binary log</code>；<code>Position</code>则表示<code>Binary log</code>日志文件的偏移量之后的都会同步到<code>slave</code>中，那么在偏移量之前的则需要我们手动导入。</p>
<p>主服务器上面的任何修改都会保存在二进制日志Binary log里面，从服务器上面启动一个I/O thread（实际上就是一个主服务器的客户端进程），连接到主服务器上面请求读取二进制日志，然后把读取到的二进制日志写到本地的一个Realy log里面。从服务器上面开启一个SQL thread定时检查Realy log，如果发现有更改立即把更改的内容在本机上面执行一遍。</p>
<p>如果一主多从的话，这时主库既要负责写又要负责为几个从库提供二进制日志。此时可以稍做调整，将二进制日志只给某一从，这一从再开启二进制日志并将自己的二进制日志再发给其它从。或者是干脆这个从不记录只负责将二进制日志转发给其它从，这样架构起来性能可能要好得多，而且数据之间的延时应该也稍微要好一些</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d11ad608bec?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>手动导入，从<code>master</code>中导出数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -proot -hlocalhost test &gt; &#x2F;export&#x2F;data&#x2F;test.sql</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>将<code>test.sql</code>中的内容在<code>slave</code>上执行一遍。</p>
<h4 id="配置slave"><a href="#配置slave" class="headerlink" title="配置slave"></a>配置slave</h4><p>修改<code>slave</code>的<code>my.ini</code>文件中的<code>[mysqld]</code>部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log-bin&#x3D;mysql</span><br><span class="line">server-id&#x3D;1 #192.168.10.1</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>保存修改后重启<code>slave</code>，<code>WIN+R</code>-&gt;<code>services.msc</code>-&gt;<code>MySQL5.7</code>-&gt;重新启动</p>
<p>登录<code>slave</code>检查<code>log_bin</code>是否以被开启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show VARIABLES like &#39;log_bin&#39;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>配置与<code>master</code>的同步复制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stop slave; </span><br><span class="line">change master to</span><br><span class="line">    master_host&#x3D;&#39;192.168.10.10&#39;,	-- master的IP</span><br><span class="line">    master_user&#x3D;&#39;backup&#39;,		    -- 之前在master上创建的用户</span><br><span class="line">    master_password&#x3D;&#39;1234&#39;,</span><br><span class="line">    master_log_file&#x3D;&#39;mysql-bin.000002&#39;, -- master上 show master status \G 提供的信息</span><br><span class="line">    master_log_pos&#x3D;154;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>启用<code>slave</code>节点并查看状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.10.10</span><br><span class="line">                  Master_User: backup</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: DESKTOP-KUBSPE0-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 154</span><br><span class="line">              Relay_Log_Space: 537</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 10</span><br><span class="line">                  Master_UUID: f68774b7-0b28-11e9-a925-000c290abe05</span><br><span class="line">             Master_Info_File: C:\ProgramData\MySQL\MySQL Server 5.7\Data\master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意查看第4、14、15三行，若与我一致，表示<code>slave</code>配置成功</p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>关闭<code>master</code>的读取锁定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>向<code>master</code>中插入一条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use test</span><br><span class="line">mysql&gt; insert into article (title,content) values (&#39;mysql master and slave&#39;,&#39;record the cluster building succeed!:)&#39;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>查看<code>slave</code>是否自动同步了数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into article (title,content) values (&#39;mysql master and slave&#39;,&#39;record the cluster building succeed!:)&#39;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>至此，主从复制的配置成功！：)</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xlgen157387/article/details/52452394">使用mysqlreplicate命令快速搭建 Mysql 主从复制</a></p>
<p>读写分离</p>
<p>读写分离是依赖于主从复制，而主从复制又是为读写分离服务的。因为主从复制要求<code>slave</code>不能写只能读（如果对<code>slave</code>执行写操作，那么<code>show slave status</code>将会呈现<code>Slave_SQL_Running=NO</code>，此时你需要按照前面提到的手动同步一下<code>slave</code>）。</p>
<h3 id="方案一、定义两种连接"><a href="#方案一、定义两种连接" class="headerlink" title="方案一、定义两种连接"></a>方案一、定义两种连接</h3><p>就像我们在学JDBC时定义的<code>DataBase</code>一样，我们可以抽取出<code>ReadDataBase,WriteDataBase implements DataBase</code>，但是这种方式无法利用优秀的线程池技术如<code>DruidDataSource</code>帮我们管理连接，也无法利用<code>Spring AOP</code>让连接对<code>DAO</code>层透明。</p>
<h3 id="方案二、使用Spring-AOP"><a href="#方案二、使用Spring-AOP" class="headerlink" title="方案二、使用Spring AOP"></a>方案二、使用Spring AOP</h3><p>如果能够使用<code>Spring AOP</code>解决数据源切换的问题，那么就可以和<code>Mybatis</code>、<code>Druid</code>整合到一起了。</p>
<p>我们在整合<code>Spring1</code>和<code>Mybatis</code>时，我们只需写DAO接口和对应的<code>SQL</code>语句，那么DAO实例是由谁创建的呢？实际上就是<code>Spring</code>帮我们创建的，它通过我们注入的数据源，帮我们完成从中获取数据库连接、使用连接执行 <code>SQL</code> 语句的过程以及最后归还连接给数据源的过程。</p>
<p>如果我们能在调用DAO接口时根据接口方法命名规范（增<code>addXXX/createXXX</code>、删<code>deleteXX/removeXXX</code>、改<code>updateXXXX</code>、查<code>selectXX/findXXX/getXX/queryXXX</code>）动态地选择数据源（读数据源对应连接<code>master</code>而写数据源对应连接<code>slave</code>），那么就可以做到读写分离了。</p>
<h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><p><img src="https://user-gold-cdn.xitu.io/2020/6/9/17296d11b51f4477?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><p>其中，为了方便访问数据库引入了<code>mybatis</code>和<code>druid</code>，实现数据源动态切换主要依赖<code>spring-aop</code>和<code>spring-aspects</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.mybatis&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mybatis-spring&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.3.2&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.mybatis&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mybatis&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.4.6&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.0.8.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-aop&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.0.8.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-jdbc&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.0.8.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;druid&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.1.6&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;6.0.2&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-context&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.0.8.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-aspects&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.0.8.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.16.22&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.0.8.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;junit&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;junit&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;4.12&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="数据类"><a href="#数据类" class="headerlink" title="数据类"></a>数据类</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package top.zhenganwen.mysqloptimize.entity;</span><br><span class="line"></span><br><span class="line">import lombok.AllArgsConstructor;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">public class Article &#123;</span><br><span class="line"></span><br><span class="line">    private int id;</span><br><span class="line">    private String title;</span><br><span class="line">    private String content;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="spring配置文件"><a href="#spring配置文件" class="headerlink" title="spring配置文件"></a>spring配置文件</h4><p>其中<code>RoutingDataSourceImpl</code>是实现动态切换功能的核心类，稍后介绍。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">       xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context&quot;</span><br><span class="line">       xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context&#x2F;spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:property-placeholder location&#x3D;&quot;db.properties&quot;&gt;&lt;&#x2F;context:property-placeholder&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package&#x3D;&quot;top.zhenganwen.mysqloptimize&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;slaveDataSource&quot; class&#x3D;&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;$&#123;db.driverClass&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;master.db.url&#125;&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;master.db.username&#125;&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;master.db.password&#125;&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;masterDataSource&quot; class&#x3D;&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;$&#123;db.driverClass&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;slave.db.url&#125;&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;slave.db.username&#125;&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;slave.db.password&#125;&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceRouting&quot; class&#x3D;&quot;top.zhenganwen.mysqloptimize.dataSource.RoutingDataSourceImpl&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;defaultTargetDataSource&quot; ref&#x3D;&quot;masterDataSource&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;targetDataSources&quot;&gt;</span><br><span class="line">            &lt;map key-type&#x3D;&quot;java.lang.String&quot; value-type&#x3D;&quot;javax.sql.DataSource&quot;&gt;</span><br><span class="line">                &lt;entry key&#x3D;&quot;read&quot; value-ref&#x3D;&quot;slaveDataSource&quot;&#x2F;&gt;</span><br><span class="line">                &lt;entry key&#x3D;&quot;write&quot; value-ref&#x3D;&quot;masterDataSource&quot;&#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;map&gt;</span><br><span class="line">        &lt;&#x2F;property&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;methodType&quot;&gt;</span><br><span class="line">            &lt;map key-type&#x3D;&quot;java.lang.String&quot; value-type&#x3D;&quot;java.lang.String&quot;&gt;</span><br><span class="line">                &lt;entry key&#x3D;&quot;read&quot; value&#x3D;&quot;query,find,select,get,load,&quot;&gt;&lt;&#x2F;entry&gt;</span><br><span class="line">                &lt;entry key&#x3D;&quot;write&quot; value&#x3D;&quot;update,add,create,delete,remove,modify&quot;&#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;map&gt;</span><br><span class="line">        &lt;&#x2F;property&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Mybatis文件 --&gt;</span><br><span class="line">    &lt;bean id&#x3D;&quot;sqlSessionFactory&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;configLocation&quot; value&#x3D;&quot;classpath:mybatis-config.xml&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSourceRouting&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;mapperLocations&quot; value&#x3D;&quot;mapper&#x2F;*.xml&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean class&#x3D;&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;basePackage&quot; value&#x3D;&quot;top.zhenganwen.mysqloptimize.mapper&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;sqlSessionFactoryBeanName&quot; value&#x3D;&quot;sqlSessionFactory&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line">&lt;&#x2F;beans&gt;</span><br><span class="line">复制代码</span><br><span class="line">dp.properties</span><br><span class="line">master.db.url&#x3D;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;test?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf8&amp;serverTimezone&#x3D;UTC</span><br><span class="line">master.db.username&#x3D;root</span><br><span class="line">master.db.password&#x3D;root</span><br><span class="line"></span><br><span class="line">slave.db.url&#x3D;jdbc:mysql:&#x2F;&#x2F;192.168.10.10:3306&#x2F;test?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf8&amp;serverTimezone&#x3D;UTC</span><br><span class="line">slave.db.username&#x3D;root</span><br><span class="line">slave.db.password&#x3D;root</span><br><span class="line"></span><br><span class="line">db.driverClass&#x3D;com.mysql.jdbc.Driver</span><br><span class="line">复制代码</span><br><span class="line">mybatis-config.xml</span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Config 3.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">        &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;typeAliases&gt;</span><br><span class="line">        &lt;typeAlias type&#x3D;&quot;top.zhenganwen.mysqloptimize.entity.Article&quot; alias&#x3D;&quot;Article&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;typeAliases&gt;</span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="mapper接口和配置文件"><a href="#mapper接口和配置文件" class="headerlink" title="mapper接口和配置文件"></a>mapper接口和配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ArticleMapper.java</span><br><span class="line">package top.zhenganwen.mysqloptimize.mapper;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Repository;</span><br><span class="line">import top.zhenganwen.mysqloptimize.entity.Article;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Repository</span><br><span class="line">public interface ArticleMapper &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Article&gt; findAll();</span><br><span class="line"></span><br><span class="line">    void add(Article article);</span><br><span class="line"></span><br><span class="line">    void delete(int id);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br><span class="line">ArticleMapper.xml</span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Mapper 3.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-mapper.dtd&quot; &gt;</span><br><span class="line">&lt;mapper namespace&#x3D;&quot;top.zhenganwen.mysqloptimize.mapper.ArticleMapper&quot;&gt;</span><br><span class="line">    &lt;select id&#x3D;&quot;findAll&quot; resultType&#x3D;&quot;Article&quot;&gt;</span><br><span class="line">        select * from article</span><br><span class="line">    &lt;&#x2F;select&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id&#x3D;&quot;add&quot; parameterType&#x3D;&quot;Article&quot;&gt;</span><br><span class="line">        insert into article (title,content) values (#&#123;title&#125;,#&#123;content&#125;)</span><br><span class="line">    &lt;&#x2F;insert&gt;</span><br><span class="line"></span><br><span class="line">    &lt;delete id&#x3D;&quot;delete&quot; parameterType&#x3D;&quot;int&quot;&gt;</span><br><span class="line">        delete from article where id&#x3D;#&#123;id&#125;</span><br><span class="line">    &lt;&#x2F;delete&gt;</span><br><span class="line">&lt;&#x2F;mapper&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h4><h5 id="RoutingDataSourceImpl"><a href="#RoutingDataSourceImpl" class="headerlink" title="RoutingDataSourceImpl"></a>RoutingDataSourceImpl</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package top.zhenganwen.mysqloptimize.dataSource;</span><br><span class="line"></span><br><span class="line">import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * RoutingDataSourceImpl class</span><br><span class="line"> * 数据源路由</span><br><span class="line"> *</span><br><span class="line"> * @author zhenganwen, blog:zhenganwen.top</span><br><span class="line"> * @date 2018&#x2F;12&#x2F;29</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class RoutingDataSourceImpl extends AbstractRoutingDataSource &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * key为read或write</span><br><span class="line">     * value为DAO方法的前缀</span><br><span class="line">     * 什么前缀开头的方法使用读数据员，什么开头的方法使用写数据源</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static final Map&lt;String, List&lt;String&gt;&gt; METHOD_TYPE_MAP &#x3D; new HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 由我们指定数据源的id，由Spring切换数据源</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    protected Object determineCurrentLookupKey() &#123;</span><br><span class="line">        System.out.println(&quot;数据源为：&quot;+DataSourceHandler.getDataSource());</span><br><span class="line">        return DataSourceHandler.getDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMethodType(Map&lt;String, String&gt; map) &#123;</span><br><span class="line">        for (String type : map.keySet()) &#123;</span><br><span class="line">            String methodPrefixList &#x3D; map.get(type);</span><br><span class="line">            if (methodPrefixList !&#x3D; null) &#123;</span><br><span class="line">                METHOD_TYPE_MAP.put(type, Arrays.asList(methodPrefixList.split(&quot;,&quot;)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>它的主要功能是，本来我们只配置一个数据源，因此<code>Spring</code>动态代理DAO接口时直接使用该数据源，现在我们有了读、写两个数据源，我们需要加入一些自己的逻辑来告诉调用哪个接口使用哪个数据源（读数据的接口使用<code>slave</code>，写数据的接口使用<code>master</code>。这个告诉<code>Spring</code>该使用哪个数据源的类就是<code>AbstractRoutingDataSource</code>，必须重写的方法<code>determineCurrentLookupKey</code>返回数据源的标识，结合<code>spring</code>配置文件（下段代码的5，6两行）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id&#x3D;&quot;dataSourceRouting&quot; class&#x3D;&quot;top.zhenganwen.mysqloptimize.dataSource.RoutingDataSourceImpl&quot;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;defaultTargetDataSource&quot; ref&#x3D;&quot;masterDataSource&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;targetDataSources&quot;&gt;</span><br><span class="line">        &lt;map key-type&#x3D;&quot;java.lang.String&quot; value-type&#x3D;&quot;javax.sql.DataSource&quot;&gt;</span><br><span class="line">            &lt;entry key&#x3D;&quot;read&quot; value-ref&#x3D;&quot;slaveDataSource&quot;&#x2F;&gt;</span><br><span class="line">            &lt;entry key&#x3D;&quot;write&quot; value-ref&#x3D;&quot;masterDataSource&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;map&gt;</span><br><span class="line">    &lt;&#x2F;property&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;methodType&quot;&gt;</span><br><span class="line">        &lt;map key-type&#x3D;&quot;java.lang.String&quot; value-type&#x3D;&quot;java.lang.String&quot;&gt;</span><br><span class="line">            &lt;entry key&#x3D;&quot;read&quot; value&#x3D;&quot;query,find,select,get,load,&quot;&gt;&lt;&#x2F;entry&gt;</span><br><span class="line">            &lt;entry key&#x3D;&quot;write&quot; value&#x3D;&quot;update,add,create,delete,remove,modify&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;map&gt;</span><br><span class="line">    &lt;&#x2F;property&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>如果<code>determineCurrentLookupKey</code>返回<code>read</code>那么使用<code>slaveDataSource</code>，如果返回<code>write</code>就使用<code>masterDataSource</code>。</p>
<h5 id="DataSourceHandler"><a href="#DataSourceHandler" class="headerlink" title="DataSourceHandler"></a>DataSourceHandler</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package top.zhenganwen.mysqloptimize.dataSource;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * DataSourceHandler class</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 将数据源与线程绑定，需要时根据线程获取</span><br><span class="line"> *</span><br><span class="line"> * @author zhenganwen, blog:zhenganwen.top</span><br><span class="line"> * @date 2018&#x2F;12&#x2F;29</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DataSourceHandler &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 绑定的是read或write，表示使用读或写数据源</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static final ThreadLocal&lt;String&gt; holder &#x3D; new ThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    public static void setDataSource(String dataSource) &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+&quot;设置了数据源类型&quot;);</span><br><span class="line">        holder.set(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getDataSource() &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+&quot;获取了数据源类型&quot;);</span><br><span class="line">        return holder.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h5 id="DataSourceAspect"><a href="#DataSourceAspect" class="headerlink" title="DataSourceAspect"></a>DataSourceAspect</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">package top.zhenganwen.mysqloptimize.dataSource;</span><br><span class="line"></span><br><span class="line">import org.aspectj.lang.JoinPoint;</span><br><span class="line">import org.aspectj.lang.annotation.Aspect;</span><br><span class="line">import org.aspectj.lang.annotation.Before;</span><br><span class="line">import org.aspectj.lang.annotation.Pointcut;</span><br><span class="line">import org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import static top.zhenganwen.mysqloptimize.dataSource.RoutingDataSourceImpl.METHOD_TYPE_MAP;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * DataSourceAspect class</span><br><span class="line"> *</span><br><span class="line"> * 配置切面，根据方法前缀设置读、写数据源</span><br><span class="line"> * 项目启动时会加载该bean，并按照配置的切面（哪些切入点、如何增强）确定动态代理逻辑</span><br><span class="line"> * @author zhenganwen,blog:zhenganwen.top</span><br><span class="line"> * @date 2018&#x2F;12&#x2F;29</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Component</span><br><span class="line">&#x2F;&#x2F;声明这是一个切面，这样Spring才会做相应的配置，否则只会当做简单的bean注入</span><br><span class="line">@Aspect</span><br><span class="line">@EnableAspectJAutoProxy</span><br><span class="line">public class DataSourceAspect &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 配置切入点：DAO包下的所有类的所有方法</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Pointcut(&quot;execution(* top.zhenganwen.mysqloptimize.mapper.*.*(..))&quot;)</span><br><span class="line">    public void aspect() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 配置前置增强，对象是aspect()方法上配置的切入点</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Before(&quot;aspect()&quot;)</span><br><span class="line">    public void before(JoinPoint point) &#123;</span><br><span class="line">        String className &#x3D; point.getTarget().getClass().getName();</span><br><span class="line">        String invokedMethod &#x3D; point.getSignature().getName();</span><br><span class="line">        System.out.println(&quot;对 &quot;+className+&quot;$&quot;+invokedMethod+&quot; 做了前置增强，确定了要使用的数据源类型&quot;);</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; dataSourceType &#x3D; METHOD_TYPE_MAP.keySet();</span><br><span class="line">        for (String type : dataSourceType) &#123;</span><br><span class="line">            List&lt;String&gt; prefixList &#x3D; METHOD_TYPE_MAP.get(type);</span><br><span class="line">            for (String prefix : prefixList) &#123;</span><br><span class="line">                if (invokedMethod.startsWith(prefix)) &#123;</span><br><span class="line">                    DataSourceHandler.setDataSource(type);</span><br><span class="line">                    System.out.println(&quot;数据源为：&quot;+type);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="测试读写分离"><a href="#测试读写分离" class="headerlink" title="测试读写分离"></a>测试读写分离</h4><blockquote>
<p>如何测试读是从<code>slave</code>中读的呢？可以将写后复制到<code>slave</code>中的数据更改，再读该数据就知道是从<code>slave</code>中读了。</p>
<p>注意</p>
<p>，一但对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slave</span><br></pre></td></tr></table></figure>

<p>做了写操作就要重新手动将</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slave</span><br></pre></td></tr></table></figure>

<p>与</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">master</span><br></pre></td></tr></table></figure>

<p>同步一下，否则主从复制就会失效。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package top.zhenganwen.mysqloptimize.dataSource;</span><br><span class="line"></span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.test.context.ContextConfiguration;</span><br><span class="line">import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line">import top.zhenganwen.mysqloptimize.entity.Article;</span><br><span class="line">import top.zhenganwen.mysqloptimize.mapper.ArticleMapper;</span><br><span class="line"></span><br><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@ContextConfiguration(locations &#x3D; &quot;classpath:spring-mybatis.xml&quot;)</span><br><span class="line">public class RoutingDataSourceTest &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    ArticleMapper articleMapper;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testRead() &#123;</span><br><span class="line">        System.out.println(articleMapper.findAll());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testAdd() &#123;</span><br><span class="line">        Article article &#x3D; new Article(0, &quot;我是新插入的文章&quot;, &quot;测试是否能够写到master并且复制到slave中&quot;);</span><br><span class="line">        articleMapper.add(article);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testDelete() &#123;</span><br><span class="line">        articleMapper.delete(2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chengxy-nds/p/12285215.html#_labelTop">回到顶部</a></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><h3 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h3><ul>
<li>轮询</li>
<li>加权轮询：按照处理能力来加权</li>
<li>负载分配：依据当前的空闲状态（但是测试每个节点的内存使用率、CPU利用率等，再做比较选出最闲的那个，效率太低）</li>
</ul>
<p>高可用</p>
<p>在服务器架构时，为了保证服务器7x24不宕机在线状态，需要为每台单点服务器（由一台服务器提供服务的服务器，如写服务器、数据库中间件）提供冗余机。</p>
<p>对于写服务器来说，需要提供一台同样的写-冗余服务器，当写服务器健康时（写-冗余通过心跳检测），写-冗余作为一个从机的角色复制写服务器的内容与其做一个同步；当写服务器宕机时，写-冗余服务器便顶上来作为写服务器继续提供服务。对外界来说这个处理过程是透明的，即外界仅通过一个IP访问服务。</p>
<h1 id="典型SQL"><a href="#典型SQL" class="headerlink" title="典型SQL"></a>典型SQL</h1><p>线上DDL</p>
<p>DDL(Database Definition Language)是指数据库表结构的定义（<code>create table</code>）和维护（<code>alter table</code>）的语言。在线上执行DDL，在低于<code>MySQL5.6</code>版本时会导致全表被独占锁定，此时表处于维护、不可操作状态，这会导致该期间对该表的所有访问无法响应。但是在<code>MySQL5.6</code>之后，支持<code>Online DDL</code>，大大缩短了锁定时间。</p>
<p>优化技巧是采用的维护表结构的DDL（比如增加一列，或者增加一个索引），是</p>
<p>copy</p>
<p>策略。思路：创建一个满足新结构的新表，将旧表数据</p>
<p>逐条</p>
<p>导入（复制）到新表中，以保证</p>
<p>一次性锁定的内容少</p>
<p>（锁定的是正在导入的数据），同时旧表上可以执行其他任务。导入的过程中，将对旧表的所有操作以日志的形式记录下来，导入完毕后，将更新日志在新表上再执行一遍（确保一致性）。最后，新表替换旧表（在应用程序中完成，或者是数据库的rename，视图完成）。</p>
<p>但随着MySQL的升级，这个问题几乎淡化了。</p>
<p>数据库导入语句</p>
<p>在恢复数据时，可能会导入大量的数据。此时为了快速导入，需要掌握一些技巧：</p>
<ol>
<li><p>导入时</p>
<p>先禁用索引和约束</p>
<p>：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table table-name disable keys</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>待数据导入完成之后，再开启索引和约束，一次性创建索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table table-name enable keys</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<ol>
<li><p>数据库如果使用的引擎是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Innodb</span><br></pre></td></tr></table></figure>

<p>，那么它</p>
<p>默认会给每条写指令加上事务</p>
<p>（这也会消耗一定的时间），因此建议先手动开启事务，再执行一定量的批量导入，最后手动提交事务。</p>
</li>
<li><p>如果批量导入的SQL指令格式相同只是数据不同，那么你应该先</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prepare</span><br></pre></td></tr></table></figure>

<p>预编译</p>
<p>一下，这样也能节省很多重复编译的时间。</p>
</li>
</ol>
<p>limit offset,rows</p>
<p>尽量保证不要出现大的<code>offset</code>，比如<code>limit 10000,10</code>相当于对已查询出来的行数弃掉前<code>10000</code>行后再取<code>10</code>行，完全可以加一些条件过滤一下（完成筛选），而不应该使用<code>limit</code>跳过已查询到的数据。这是一个</p>
<p><code>offset</code>做无用功</p>
<p>的问题。对应实际工程中，要避免出现大页码的情况，尽量引导用户做条件过滤。</p>
<p>select * 要少用</p>
<p>即尽量选择自己需要的字段<code>select</code>，但这个影响不是很大，因为网络传输多了几十上百字节也没多少延时，并且现在流行的ORM框架都是用的<code>select *</code>，只是我们在设计表的时候注意将大数据量的字段分离，比如商品详情可以单独抽离出一张商品详情表，这样在查看商品简略页面时的加载速度就不会有影响了。</p>
<p>order by rand()不要用</p>
<p>它的逻辑就是随机排序（为每条数据生成一个随机数，然后根据随机数大小进行排序）。如<code>select * from student order by rand() limit 5</code>的执行效率就很低，因为它为表中的每条数据都生成随机数并进行排序，而我们只要前5条。</p>
<p>解决思路：在应用程序中，将随机的主键生成好，去数据库中利用主键检索。</p>
<p>单表和多表查询</p>
<p>多表查询：<code>join</code>、子查询都是涉及到多表的查询。如果你使用<code>explain</code>分析执行计划你会发现多表查询也是一个表一个表的处理，最后合并结果。因此可以说单表查询将计算压力放在了应用程序上，而多表查询将计算压力放在了数据库上。</p>
<p>现在有ORM框架帮我们解决了单表查询带来的对象映射问题（查询单表时，如果发现有外键自动再去查询关联表，是一个表一个表查的）。</p>
<p>count(*)</p>
<p>在<code>MyISAM</code>存储引擎中，会自动记录表的行数，因此使用<code>count(*)</code>能够快速返回。而<code>Innodb</code>内部没有这样一个计数器，需要我们手动统计记录数量，解决思路就是单独使用一张表：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>table</th>
<th>count</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>student</td>
<td>100</td>
</tr>
</tbody></table>
<p>limit 1</p>
<p>如果可以确定仅仅检索一条，建议加上<code>limit 1</code>，其实ORM框架帮我们做到了这一点（查询单条的操作都会自动加上<code>limit 1</code>）。</p>
<h1 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h1><blockquote>
<p>用于记录执行时间超过某个临界值的SQL日志，用于快速定位慢查询，为我们的优化做参考。</p>
</blockquote>
<p>开启慢查询日志</p>
<p>配置项：<code>slow_query_log</code></p>
<p>可以使用<code>show variables like ‘slov_query_log’</code>查看是否开启，如果状态值为<code>OFF</code>，可以使用<code>set GLOBAL slow_query_log = on</code>来开启，它会在<code>datadir</code>下产生一个<code>xxx-slow.log</code>的文件。</p>
<p>设置临界时间</p>
<p>配置项：<code>long_query_time</code></p>
<p>查看：<code>show VARIABLES like &#39;long_query_time&#39;</code>，单位秒</p>
<p>设置：<code>set long_query_time=0.5</code></p>
<p>实操时应该从长时间设置到短的时间，即将最慢的SQL优化掉</p>
<p>查看日志</p>
<p>一旦SQL超过了我们设置的临界时间就会被记录到<code>xxx-slow.log</code>中</p>
<h1 id="profile信息"><a href="#profile信息" class="headerlink" title="profile信息"></a>profile信息</h1><p>配置项：<code>profiling</code></p>
<p>开启profile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set profiling&#x3D;on</span><br></pre></td></tr></table></figure>

<p>开启后，所有的SQL执行的详细信息都会被自动记录下来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;profiling&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| profiling     | OFF   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set profiling&#x3D;on;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>查看profile信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">show profiles</span><br><span class="line">mysql&gt; show variables like &#39;profiling&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| profiling     | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into article values (null,&#39;test profile&#39;,&#39;:)&#39;);</span><br><span class="line">Query OK, 1 row affected (0.15 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show profiles;</span><br><span class="line">+----------+------------+-------------------------------------------------------+</span><br><span class="line">| Query_ID | Duration   | Query                                                 |</span><br><span class="line">+----------+------------+-------------------------------------------------------+</span><br><span class="line">|        1 | 0.00086150 | show variables like &#39;profiling&#39;                       |</span><br><span class="line">|        2 | 0.15027550 | insert into article values (null,&#39;test profile&#39;,&#39;:)&#39;) |</span><br><span class="line">+----------+------------+-------------------------------------------------------+</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>通过Query_ID查看某条SQL所有详细步骤的时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show profile for query Query_ID</span><br></pre></td></tr></table></figure>

<p>上面<code>show profiles</code>的结果中，每个SQL有一个<code>Query_ID</code>，可以通过它查看执行该SQL经过了哪些步骤，各消耗了多场时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h1 id="典型的服务器配置"><a href="#典型的服务器配置" class="headerlink" title="典型的服务器配置"></a>典型的服务器配置</h1><blockquote>
<p>以下的配置全都取决于实际的运行环境</p>
</blockquote>
<ul>
<li><p><code>max_connections</code>，最大客户端连接数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;max_connections&#39;;</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| Variable_name   | Value |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| max_connections | 151   |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure></li>
<li><p><code>table_open_cache</code>，表文件句柄缓存（表数据是存储在磁盘上的，缓存磁盘文件的句柄方便打开文件读取数据）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;table_open_cache&#39;;</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| table_open_cache | 2000  |</span><br><span class="line">+------------------+-------+</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure></li>
<li><p><code>key_buffer_size</code>，索引缓存大小（将从磁盘上读取的索引缓存到内存，可以设置大一些，有利于快速检索）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;key_buffer_size&#39;;</span><br><span class="line">+-----------------+---------+</span><br><span class="line">| Variable_name   | Value   |</span><br><span class="line">+-----------------+---------+</span><br><span class="line">| key_buffer_size | 8388608 |</span><br><span class="line">+-----------------+---------+</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure></li>
<li><p><code>innodb_buffer_pool_size</code>，<code>Innodb</code>存储引擎缓存池大小（对于<code>Innodb</code>来说最重要的一个配置，如果所有的表用的都是<code>Innodb</code>，那么甚至建议将该值设置到物理内存的80%，<code>Innodb</code>的很多性能提升如索引都是依靠这个）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;innodb_buffer_pool_size&#39;;</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| Variable_name           | Value   |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| innodb_buffer_pool_size | 8388608 |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure></li>
<li><p><code>innodb_file_per_table</code>（<code>innodb</code>中，表数据存放在<code>.ibd</code>文件中，如果将该配置项设置为<code>ON</code>，那么一个表对应一个<code>ibd</code>文件，否则所有<code>innodb</code>共享表空间）</p>
</li>
</ul>
<h1 id="压测工具mysqlslap"><a href="#压测工具mysqlslap" class="headerlink" title="压测工具mysqlslap"></a>压测工具mysqlslap</h1><p>安装MySQL时附带了一个压力测试工具<code>mysqlslap</code>（位于<code>bin</code>目录下）</p>
<p>自动生成sql测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\zaw&gt;mysqlslap --auto-generate-sql -uroot -proot</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">        Average number of seconds to run all queries: 1.219 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 1.219 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 1.219 seconds</span><br><span class="line">        Number of clients running queries: 1</span><br><span class="line">        Average number of queries per client: 0</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>并发测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\zaw&gt;mysqlslap --auto-generate-sql --concurrency&#x3D;100 -uroot -proot</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">        Average number of seconds to run all queries: 3.578 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 3.578 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 3.578 seconds</span><br><span class="line">        Number of clients running queries: 100</span><br><span class="line">        Average number of queries per client: 0</span><br><span class="line">        </span><br><span class="line">C:\Users\zaw&gt;mysqlslap --auto-generate-sql --concurrency&#x3D;150 -uroot -proot</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">        Average number of seconds to run all queries: 5.718 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 5.718 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 5.718 seconds</span><br><span class="line">        Number of clients running queries: 150</span><br><span class="line">        Average number of queries per client: 0</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>多轮测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\zaw&gt;mysqlslap --auto-generate-sql --concurrency&#x3D;150 --iterations&#x3D;10 -uroot -proot</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">        Average number of seconds to run all queries: 5.398 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 4.313 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 6.265 seconds</span><br><span class="line">        Number of clients running queries: 150</span><br><span class="line">        Average number of queries per client: 0</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>存储引擎测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\zaw&gt;mysqlslap --auto-generate-sql --concurrency&#x3D;150 --iterations&#x3D;3 --engine&#x3D;innodb -uroot -proot</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">        Running for engine innodb</span><br><span class="line">        Average number of seconds to run all queries: 5.911 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 5.485 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 6.703 seconds</span><br><span class="line">        Number of clients running queries: 150</span><br><span class="line">        Average number of queries per client: 0</span><br><span class="line">复制代码</span><br><span class="line">C:\Users\zaw&gt;mysqlslap --auto-generate-sql --concurrency&#x3D;150 --iterations&#x3D;3 --engine&#x3D;myisam -uroot -proot</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">        Running for engine myisam</span><br><span class="line">        Average number of seconds to run all queries: 53.104 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 46.843 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 60.781 seconds</span><br><span class="line">        Number of clients running queries: 150</span><br><span class="line">        Average number of queries per client: 0</span><br></pre></td></tr></table></figure>


<p>作者：爱Rap篮球写代码的蔡徐<br>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904183850598407">https://juejin.cn/post/6844904183850598407</a><br>来源：掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/04/25/java%E9%9D%A2%E8%AF%95/" rel="prev" title="java面试">
                  <i class="fa fa-chevron-left"></i> java面试
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">vivid</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
